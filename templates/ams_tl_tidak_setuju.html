<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tindak Lanjut Tidak Setuju</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link rel="icon" href="{{ url_for('static', filename='favicon-32x32.png') }}" type="image/png"/>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        .nav-links a.active {
            font-weight: 700 !important;
            color: #C62828 !important;
        }

        .nav-links > li > a.active::after {
            width: 100%;
        }
        
        .wide-table-container {
            overflow-x: auto;
            max-width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            background: white;
            margin-bottom: 20px;
        }

        .wide-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
            min-width: 1900px;
        }

        .wide-table th, .wide-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #f9f9f9;
            vertical-align: middle;
            line-height: 1.6;
        }

        .wide-table th {
            background-color: #e3f2fd;
            color: #0d47a1;
            font-weight: 700;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            vertical-align: middle;
        }

        .sticky-col-right {
            position: sticky;
            right: 0;
            z-index: 11;
            border-left: 2px solid #e0e0e0;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
            text-align: center;
            background-color: #fff;
            vertical-align: middle !important;
        }
        
        th.sticky-col-right {
            background-color: #e3f2fd !important;
            z-index: 12;
        }

        .col-sm { 
            min-width: 100px; 
            text-align: center; 
            vertical-align: middle !important; 
        }
        .col-md { 
            min-width: 180px; 
            text-align: center; 
            vertical-align: middle !important; 
        }
        
        .col-lg { 
            min-width: 350px; 
            max-width: 500px; 
            white-space: pre-wrap; 
            text-align: justify;
            vertical-align: middle !important;
        }

        .btn-group { display: flex; align-items: center; gap: 10px; }
        .btn-group button {
            height: 40px; padding: 0 1.2rem;
            border: none; border-radius: 8px;
            font-size: 0.9rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-group button:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .btn-share { background-color: #1976D2; }
        .btn-excel { background-color: #2E7D32; }
        .btn-image { background-color: #009688; }
        .btn-add { background-color: var(--primary); }
        .btn-delete { background-color: #dc3545; }

        .filter-bar {
            display: flex; 
            gap: 20px; 
            margin-bottom: 1.5rem;
            background: #fff; 
            padding: 15px; 
            border-radius: 12px;
            border: 1px solid #eee; 
            align-items: flex-end; 
            flex-wrap: wrap;
        }
        
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .filter-label { 
            font-weight: 700; 
            font-size: 0.9rem; 
            color: #555; 
            margin: 0; 
            line-height: 1.2; 
        }
        
        .custom-input {
            padding: 0 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px;
            font-size: 0.9rem; 
            height: 42px !important; 
            line-height: 40px; 
            box-sizing: border-box;
            background-color: #fff;
        }
        .custom-input:focus { outline: none; border-color: var(--primary); }

        #share-modal .modal-content {
            padding: 0 !important;
            overflow: hidden;
            width: 420px; 
            max-width: 95vw;
            border-radius: 12px;
        }

        .share-header {
            padding: 20px 25px 15px 25px;
            text-align: center;
            position: relative;
            background-color: #fff;
        }

        .share-header h3 {
            color: #C62828; font-size: 1.5rem; font-weight: 700; margin: 0 0 5px 0; border: none;
        }
        .share-header p { color: #666; font-size: 0.9rem; margin: 0; }
        
        .share-table-wrapper {
            max-height: 350px; overflow-y: auto;
            border-top: 1px solid #eee; border-bottom: 1px solid #eee;
            margin-bottom: 0;
        }
        .share-table { width: 100%; border-collapse: collapse; }
        
        .share-table th {
            background-color: #F8F9FA; color: #444; font-weight: 700;
            padding: 12px 15px; text-align: left; font-size: 0.85rem;
            position: sticky; top: 0; z-index: 2; border-bottom: 1px solid #ddd;
        }
        .share-table td {
            padding: 10px 15px; border-bottom: 1px solid #f5f5f5;
            color: #333; font-size: 0.9rem; vertical-align: middle;
        }

        .share-table th:nth-child(1), .share-table td:nth-child(1) {
            width: 40px; text-align: center; padding-left: 20px;
        }
        .share-table th:nth-child(2), .share-table td:nth-child(2) {
            text-align: left;
        }
        .share-table th:nth-child(3), .share-table td:nth-child(3) {
            text-align: left; width: 80px; padding-right: 20px;
        }

        .share-footer { 
            padding: 20px 25px 25px 25px; background-color: #fff;
            display: flex; gap: 10px;
        }
        .btn-share-cancel {
            flex: 1; background-color: #fff; color: #555;
            border: 1px solid #ccc; padding: 10px; font-size: 1rem; font-weight: 600;
            border-radius: 8px; cursor: pointer; transition: all 0.2s;
        }
        .btn-share-cancel:hover { background-color: #f5f5f5; color: #333; }
        
        .btn-share-submit {
            flex: 1; background-color: #D32F2F; color: white;
            border: none; padding: 10px; font-size: 1rem; font-weight: 600;
            border-radius: 8px; cursor: pointer; transition: background 0.2s;
            box-shadow: 0 4px 6px rgba(211, 47, 47, 0.2);
        }
        .btn-share-submit:hover { background-color: #B71C1C; transform: translateY(-1px); }

        .share-close-x {
            position: absolute; top: 20px; right: 20px; font-size: 24px;
            cursor: pointer; color: #aaa; z-index: 5;
        }
        .share-close-x:hover { color: #333; }

        .shared-badge {
            font-size: 0.75rem; background-color: #E3F2FD; color: #1565C0;
            padding: 2px 6px; border-radius: 4px; font-weight: bold;
            display: inline-block; margin-bottom: 4px;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-logo">
            <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='Logo_IFG-removebg-preview.png') }}" alt="Logo"></a>
        </div>
        <ul class="nav-links">
            <li><a href="{{ url_for('dashboard') }}">Home</a></li>
            <li class="nav-dropdown-container">
                    <a href="#" class="nav-dropbtn">
                        Analisis Dokumen <span style="font-size: 0.7em;">▼</span>
                    </a>
                    <div class="nav-dropdown-content">
                        <a href="{{ url_for('dashboard') }}#folder-management">Folder</a>
                        <a href="{{ url_for('dashboard') }}#fitur">Proofread</a>
                        
                        <a href="{{ url_for('log_analysis_page') }}">Log Analisis</a>
                    </div>
                </li> 
            <li class="nav-dropdown-container">
                <a href="#" class="nav-dropbtn" style="color:var(--primary-color, #C62828); font-weight: 700;">Tindak Lanjut <span style="font-size: 0.7em;">▼</span></a>
                <div class="nav-dropdown-content">
                    <a href="{{ url_for('monitoring_ams_page') }}">Rekap Monitoring</a>
                    <a href="{{ url_for('ams_temuan_page') }}">Temuan</a>
                    <a href="{{ url_for('ams_reminder_page') }}">Reminder</a>
                    <a href="{{ url_for('ams_tl_tidak_setuju_page') }}" class="active">TL Tidak Setuju</a>
                    <a href="{{ url_for('ams_auditors_page') }}">Auditors</a>
                </div>
            </li>
            <li><a href="{{ url_for('mailbox_page') }}" class="active-mailbox">Email</a></li>
            <li><a href="{{ url_for('library_page') }}">Library</a></li>
        </ul>
        <div class="nav-extra">
            <span class="nav-user-greeting">Halo, {{ current_user.fullname }} ({{ current_user.label }})</span>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
    </nav>

    <main class="monitoring-main">
        <section class="monitoring-header">
            <h1>Tindak Lanjut Tidak Setuju</h1>
            <div class="btn-group">
                <input type="file" id="file-excel-input" style="display:none;" accept=".xlsx, .xls">
                <input type="file" id="file-image" style="display:none;" accept="image/*">
                
                <button id="btn-share" class="btn-share">Share</button>
                <button id="btn-import-excel" class="btn-excel">Import Excel</button>
                <button class="btn-image" onclick="document.getElementById('file-image').click()">Upload Gambar</button>
                <button id="add-btn" class="btn-add">Tambah Manual</button>
                <button id="delete-all-btn" class="btn-delete">Hapus Semua</button>
            </div>
        </section>

        <div class="filter-bar" style="align-items: flex-end;">
            <div class="filter-group">
                <label class="filter-label">Filter by:</label>
                <select id="filter-column" class="custom-input">
                    <option value="all">Semua Kolom</option>
                    <option value="no_aoi">No AOI</option>
                    <option value="jenis_aoi">Jenis AOI</option>
                    <option value="klasifikasi">Klasifikasi</option>
                    <option value="no_lha">No LHA</option>
                    <option value="nama_penugasan">Nama Penugasan</option>
                    <option value="keterangan">Keterangan</option>
                    <option value="temuan">Temuan</option>
                    <option value="rekomendasi">Rekomendasi</option>
                    <option value="auditee">Auditee</option>
                    <option value="tindak_lanjut">Tindak Lanjut</option>
                </select>
            </div>
            <div class="filter-group" style="flex-grow: 1;">
                <label class="filter-label" style="margin-bottom: 12px;">Search:</label>
                <input type="text" id="search-input" class="custom-input" placeholder="Ketik untuk mencari..." style="width: 100%;">
            </div>
        </div>

        <section class="data-table-container" style="background: white; padding: 0; border-radius: 10px; overflow: hidden;">
            <div class="wide-table-container" style="border: none; box-shadow: none; margin: 0;">
                <table class="wide-table">
                    <thead>
                        <tr>
                            <th class="col-sm">No AOI</th>
                            <th class="col-sm">Jenis AOI</th>
                            <th class="col-md">Klasifikasi</th>
                            <th class="col-md">No LHA</th>
                            <th class="col-md">Nama Penugasan</th>
                            
                            <th class="col-lg">Temuan</th>           
                            <th class="col-lg">Rekomendasi</th>      
                            <th class="col-md">Auditee</th>
                            <th class="col-md">Target per LHA</th>
                            <th class="col-md">Perubahan Target</th>
                            <th class="col-lg">Tindak Lanjut</th>
                            <th class="col-lg">Keterangan</th>       <th class="sticky-col-right" style="width: 140px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <p>2025 Dashboard CoE | Departemen Center of Excellence, Satuan Kerja Audit Internal | Indonesia Financial Group</p>
    </footer>

    <div id="share-modal" class="modal hidden">
        <div class="modal-content">
            <span class="share-close-x" id="close-share-modal">&times;</span>
            <div class="share-header">
                <h3>Share Data TL Tidak Setuju</h3>
                <p>Pilih pengguna yang ingin diberi akses.</p>
            </div>
            
            <div class="share-table-wrapper">
                <table class="share-table">
                    <thead>
                        <tr style="background-color: #f4f4f4;">
                            <th style="width: 40px;"><input type="checkbox" id="select-all-users"></th>
                            <th data-sort-key="name" class="sortable" style="width: 160px;">Nama <span class="sort-icon"></span></th>
                            <th data-sort-key="label" class="sortable" style="width: 100px;">Label <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="share-table-body">
                        <tr><td colspan="3" style="text-align:center; padding:20px;">Memuat user...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="share-footer">
                <button id="cancel-share-modal-btn" class="btn-share-cancel">Batal</button>
                <button id="submit-share-btn" class="btn-share-submit">Share</button>
            </div>
        </div>
    </div>
    
    <div id="form-modal" class="modal hidden">
        <div class="modal-content box-layout-modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="close-btn" id="close-modal">&times;</span>
            <h2 id="modal-title">Tambah Data</h2>
            <form id="data-form">
                <input type="hidden" name="id" id="data-id">
                <div class="form-grid-wrapper" style="grid-template-columns: 1fr 1fr 1fr;"> 
                    <div class="form-group"><label>No AOI</label><input type="text" name="no_aoi" id="no_aoi"></div>
                    <div class="form-group"><label>Jenis AOI</label><input type="text" name="jenis_aoi" id="jenis_aoi"></div>
                    <div class="form-group"><label>Klasifikasi</label><input type="text" name="klasifikasi" id="klasifikasi"></div>
                    <div class="form-group"><label>No LHA</label><input type="text" name="no_lha" id="no_lha"></div>
                    <div class="form-group"><label>Nama Penugasan</label><input type="text" name="nama_penugasan" id="nama_penugasan"></div>
                    <div class="form-group"><label>Auditee</label><input type="text" name="auditee" id="auditee"></div>
                    <div class="form-group"><label>Target per LHA</label><input type="date" name="target_per_lha" id="target_per_lha"></div>
                    <div class="form-group"><label>Perubahan Target</label><input type="date" name="perubahan_target_date" id="perubahan_target_date"></div>
                </div>
                <div class="form-group" style="margin-bottom: 1rem;"><label style="font-weight:600;">Keterangan</label><textarea name="keterangan" id="keterangan" rows="2" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea></div>
                <div class="form-group" style="margin-bottom: 1rem;"><label style="font-weight:600;">Temuan</label><textarea name="temuan" id="temuan" rows="2" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea></div>
                <div class="form-group" style="margin-bottom: 1rem;"><label style="font-weight:600;">Rekomendasi</label><textarea name="rekomendasi" id="rekomendasi" rows="2" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea></div>
                <div class="form-group" style="margin-bottom: 1rem;"><label style="font-weight:600;">Tindak Lanjut</label><textarea name="tindak_lanjut" id="tindak_lanjut" rows="2" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc;"></textarea></div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" id="cancel-btn">Batal</button>
                    <button type="submit" class="submit-btn">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="sheet-selection-modal" class="modal hidden" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close-btn" id="close-sheet-modal">&times;</span>
            <h3 style="text-align:center; margin:0 0 1rem;">Pilih Sheet Excel</h3>
            <p style="text-align:center; color:#666; margin-bottom:1rem;">Pilih sheet yang berisi data untuk diimport:</p>
            <div class="form-group">
                <select id="excel-sheet-select" style="width: 100%; padding: 10px; font-size:1rem;"></select>
            </div>
            <div class="modal-actions" style="justify-content: center; margin-top: 1.5rem;">
                <button type="button" class="cancel-btn" id="cancel-sheet-btn">Batal</button>
                <button type="button" class="submit-btn" id="process-import-btn" style="background-color: #2E7D32;">Proses Import</button>
            </div>
        </div>
    </div>

    <div id="import-progress-modal" class="modal hidden" style="z-index: 2100; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="max-width: 300px; text-align: center; padding: 2rem;">
            <div class="spinner" style="margin: 0 auto 1rem auto; border-left-color: var(--primary);"></div>
            <p id="loading-text" style="color: #666; font-weight: 600;">Memproses Data...</p>
        </div>
    </div>

    <div id="custom-message-modal" class="modal hidden">
        <div class="modal-content custom-message-box">
            <h3 id="custom-message-title">Pesan</h3>
            <p id="custom-message-text" style="text-align: center; margin: 1rem 0;"></p>
            <button id="custom-message-ok-btn" class="login-btn full-width">OK</button>
        </div>
    </div>
    <div id="custom-confirm-modal" class="modal hidden">
        <div class="modal-content custom-confirm-box">
            <h3 id="custom-confirm-title">Konfirmasi</h3>
            <p id="custom-confirm-text" style="text-align: center; margin: 1rem 0;"></p>
            <div class="confirm-actions" style="display: flex; gap: 1rem; justify-content: center;">
                <button id="custom-confirm-ok-btn" class="login-btn" style="flex: 1;">Ya</button>
                <button id="custom-confirm-cancel-btn" class="login-btn" style="flex: 1; background-color: #6c757d;">Batal</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('table-body');
            const filterColumn = document.getElementById('filter-column');
            const searchInput = document.getElementById('search-input');
            let allData = []; 
            let currentUserId = "{{ current_user.id }}"; 
            let currentWorkbook = null;

            function openModalElement(el) { el.classList.remove('hidden'); }
            function closeModalElement(el) { el.classList.add('hidden'); }
            
            function showMessage(msg, type='info') {
                const m = document.getElementById('custom-message-modal');
                document.getElementById('custom-message-text').textContent = msg;
                const titleEl = document.getElementById('custom-message-title');
                titleEl.textContent = type === 'success' ? 'Sukses' : (type === 'error' ? 'Error' : 'Informasi');
                titleEl.style.color = type === 'error' ? '#d32f2f' : (type === 'success' ? '#388E3C' : '#1976D2');
                openModalElement(m);
            }
            document.getElementById('custom-message-ok-btn').onclick = () => closeModalElement(document.getElementById('custom-message-modal'));

            function showConfirm(msg, onConfirm) {
                const m = document.getElementById('custom-confirm-modal');
                document.getElementById('custom-confirm-text').textContent = msg;
                const okBtn = document.getElementById('custom-confirm-ok-btn');
                
                const newOk = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOk, okBtn);
                newOk.onclick = () => { closeModalElement(m); onConfirm(true); };
                document.getElementById('custom-confirm-cancel-btn').onclick = () => { closeModalElement(m); onConfirm(false); };
                openModalElement(m);
            }

            async function fetchData() {
                tableBody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding:2rem;">Memuat data...</td></tr>';
                try {
                    const res = await fetch('/api/tl_tidak_setuju/get');
                    allData = await res.json();
                    renderTable(allData);
                } catch(e) { console.error(e); }
            }

            function formatLongText(val) {
                if (!val || val.toString().trim() === '' || val.toString().trim() === '-') {
                    return { text: '-', style: 'text-align: center; vertical-align: middle;' };
                }
                return { text: val, style: 'text-align: justify; vertical-align: middle; white-space: pre-wrap;' };
            }
            
            function formatDisplayDate(dateStr) {
                if (!dateStr || dateStr.toString().trim() === '-') return '-';
                try {
                    const d = new Date(dateStr);
                    if (isNaN(d.getTime())) return dateStr;
                    return d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } catch {
                    return dateStr;
                }
            }

            function renderTable(data) {
                tableBody.innerHTML = '';
                if(data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding:2rem;">Data tidak ditemukan.</td></tr>';
                    return;
                }
                data.forEach(item => {
                    const isShared = item.is_shared;
                    const badge = isShared ? `<div class="shared-badge">Shared by: ${item.owner_name}</div>` : '';
                    const disabledAttr = isShared ? 'disabled style="background-color:#ccc; cursor:not-allowed;"' : '';
                    const editAction = isShared ? '' : `onclick='window.openEdit(${JSON.stringify(item).replace(/'/g, "&#39;")})'`;
                    const deleteAction = isShared ? '' : `onclick="window.deleteItem(${item.id})"`;

                    const ket = formatLongText(item.keterangan);
                    const tem = formatLongText(item.temuan);
                    const rek = formatLongText(item.rekomendasi);
                    const tl  = formatLongText(item.tindak_lanjut);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="col-sm">${badge}${item.no_aoi || '-'}</td>
                        <td class="col-sm">${item.jenis_aoi || '-'}</td>
                        <td class="col-md">${item.klasifikasi || '-'}</td>
                        <td class="col-md">${item.no_lha || '-'}</td>
                        <td class="col-md">${item.nama_penugasan || '-'}</td>
                        
                        <td class="col-lg" style="${tem.style}">${tem.text}</td>
                        <td class="col-lg" style="${rek.style}">${rek.text}</td>
                        <td class="col-md">${item.auditee || '-'}</td>
                        <td class="col-md">${formatDisplayDate(item.target_per_lha)}</td>
                        <td class="col-md">${formatDisplayDate(item.perubahan_target_date)}</td>
                        <td class="col-lg" style="${tl.style}">${tl.text}</td>
                        <td class="col-lg" style="${ket.style}">${ket.text}</td>
                        
                        <td class="sticky-col-right">
                            <div style="display:flex; gap:5px; justify-content:center;">
                                <button class="edit-result-btn" ${disabledAttr} ${editAction} style="background:#1976d2; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size:0.85em;">Edit</button>
                                <button class="delete-result-btn" ${disabledAttr} ${deleteAction} style="background:#d32f2f; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-size:0.85em;">Hapus</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            let allUsers = [];
            let lastSortKey = 'label'; 
            let lastSortDirection = 'asc';
            
            function setupSelectAllListener(tbody) {
                const selectAll = document.getElementById('select-all-users');
                if (selectAll) {
                    selectAll.onclick = function() {
                        tbody.querySelectorAll('.user-checkbox').forEach(cb => {
                            cb.checked = this.checked;
                        });
                    };
                }
            }

            function renderUserTable(users) {
                const tbody = document.getElementById('share-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                users.forEach(user => {
                    if (user.id == currentUserId) return;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox" class="user-checkbox" value="${user.id}" style="transform: scale(1.3); cursor: pointer;"></td>
                        <td>${user.fullname}</td>
                        <td><span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.85rem;">${user.label}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
                setupSelectAllListener(tbody);
            }

            function sortUserTable(key) {
                const tbody = document.getElementById('share-table-body');
                if (!tbody || allUsers.length === 0) return;

                document.querySelectorAll('.share-table th.sortable').forEach(h => {
                    h.classList.remove('asc', 'desc');
                    h.querySelector('.sort-icon').textContent = '';
                });

                const isAscending = lastSortKey !== key || lastSortDirection === 'desc';
                const direction = isAscending ? 'asc' : 'desc';

                const currentHeader = document.querySelector(`.share-table th[data-sort-key="${key}"]`);
                if (currentHeader) {
                    currentHeader.classList.add(direction);
                    currentHeader.querySelector('.sort-icon').textContent = isAscending ? '▲' : '▼';
                }

                const sortedUsers = [...allUsers].sort((a, b) => {
                    let valA, valB;
                    const dirMultiplier = isAscending ? 1 : -1;

                    if (key === 'label') {
                        valA = a.label.toLowerCase();
                        valB = b.label.toLowerCase();
                        if (valA < valB) return -1 * dirMultiplier;
                        if (valA > valB) return 1 * dirMultiplier;

                        valA = a.fullname.toLowerCase();
                        valB = b.fullname.toLowerCase();
                        if (valA < valB) return -1; 
                        if (valA > valB) return 1;
                        return 0;

                    } else if (key === 'name') {
                        valA = a.fullname.toLowerCase();
                        valB = b.fullname.toLowerCase();
                        if (valA < valB) return -1 * dirMultiplier;
                        if (valA > valB) return 1 * dirMultiplier;

                        valA = a.label.toLowerCase();
                        valB = b.label.toLowerCase();
                        if (valA < valB) return -1;
                        if (valA > valB) return 1;
                        return 0;
                    }
                    return 0;
                });

                lastSortKey = key;
                lastSortDirection = direction;
                renderUserTable(sortedUsers);
            }
            
            function setupShareEventListeners() {
                document.querySelectorAll('.share-table th.sortable').forEach(header => {
                    header.addEventListener('click', function() {
                        const sortKey = this.getAttribute('data-sort-key');
                        sortUserTable(sortKey);
                    });
                });
            }

            const btnShare = document.getElementById('btn-share');
            const shareModal = document.getElementById('share-modal');
            const shareTableBody = document.getElementById('share-table-body');
            const btnSubmitShare = document.getElementById('submit-share-btn');
            const btnCancelShare = document.getElementById('cancel-share-modal-btn');
            const closeShareX = document.getElementById('close-share-modal');


            const handleShareClick = async () => {
                openModalElement(shareModal);
                shareTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Memuat user...</td></tr>';
                try {
                    const res = await fetch('/api/get_all_users');
                    allUsers = await res.json();
                    
                    allUsers = allUsers.filter(u => u.id != currentUserId); 
                    
                    if(allUsers.length === 0) {
                        shareTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Tidak ada user lain.</td></tr>';
                        return;
                    }
                    
                    setupShareEventListeners();
                    sortUserTable(lastSortKey);

                } catch(e) { shareTableBody.innerHTML = '<tr><td colspan="3" style="color:red; text-align:center;">Gagal load user.</td></tr>'; }
            };
            
            btnShare.onclick = handleShareClick;
            closeShareX.onclick = () => closeModalElement(shareModal);
            btnCancelShare.onclick = () => closeModalElement(shareModal);

            btnSubmitShare.onclick = async () => {
                const ids = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
                if(ids.length === 0) return alert("Pilih minimal satu user.");
                
                btnSubmitShare.textContent = "Sharing...";
                btnSubmitShare.disabled = true;
                
                try {
                    const res = await fetch('/api/tl_tidak_setuju/share', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ user_ids: ids })
                    });
                    const result = await res.json();
                    closeModalElement(shareModal);
                    if(res.ok) showMessage(result.message, 'success');
                    else showMessage(result.error, 'error');
                } catch(e) { showMessage("Gagal: "+e, 'error'); }
                finally { btnSubmitShare.textContent = "Share"; btnSubmitShare.disabled = false; }
            };

            const btnImport = document.getElementById('btn-import-excel');
            const fileInput = document.getElementById('file-excel-input');
            const sheetModal = document.getElementById('sheet-selection-modal');
            const sheetSelect = document.getElementById('excel-sheet-select');
            const loadingModal = document.getElementById('import-progress-modal');
            
            btnImport.onclick = () => { fileInput.value = ''; fileInput.click(); };

            fileInput.onchange = (e) => {
                if(!e.target.files.length) return;
                openModalElement(loadingModal);
                document.getElementById('loading-text').textContent = "Membaca Excel...";
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        currentWorkbook = XLSX.read(data, {type: 'array'});
                        sheetSelect.innerHTML = '';
                        currentWorkbook.SheetNames.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name; opt.textContent = name;
                            sheetSelect.appendChild(opt);
                        });
                        closeModalElement(loadingModal);
                        openModalElement(sheetModal);
                    } catch(err) { closeModalElement(loadingModal); showMessage("Gagal baca Excel: " + err, 'error'); }
                };
                reader.readAsArrayBuffer(e.target.files[0]);
            };

            document.getElementById('process-import-btn').onclick = async () => {
                const sheetName = sheetSelect.value;
                if(!currentWorkbook || !sheetName) return;
                closeModalElement(sheetModal);
                openModalElement(loadingModal);
                document.getElementById('loading-text').textContent = "Mengupload Data...";

                try {
                    const worksheet = currentWorkbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    let headerRowIndex = 0;
                    for (let i = 0; i < Math.min(rawData.length, 10); i++) {
                        const rowStr = JSON.stringify(rawData[i]).toLowerCase();
                        if (rowStr.includes("no aoi") || rowStr.includes("klasifikasi") || rowStr.includes("no lha")) {
                            headerRowIndex = i; break;
                        }
                    }
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "", raw: false, dateNF: 'yyyy-mm-dd', range: headerRowIndex });
                    
                    const res = await fetch('/api/tl_tidak_setuju/import_json', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ data: jsonData })
                    });
                    const result = await res.json();
                    closeModalElement(loadingModal);
                    if(res.ok) { showMessage(result.message, 'success'); fetchData(); }
                    else showMessage(result.error, 'error');
                } catch(err) { closeModalElement(loadingModal); showMessage("Error: " + err.message, 'error'); }
            };

            const fileImage = document.getElementById('file-image');
            fileImage.onchange = (e) => {
                if(!e.target.files.length) return;
                showConfirm("Proses gambar ini dengan AI?", async (yes) => {
                    if(yes) {
                        openModalElement(loadingModal);
                        document.getElementById('loading-text').textContent = "Memproses Gambar...";
                        const formData = new FormData();
                        formData.append('file', e.target.files[0]);
                        try {
                            const res = await fetch('/api/tl_tidak_setuju/upload_image', { method:'POST', body:formData });
                            const result = await res.json();
                            closeModalElement(loadingModal);
                            if(res.ok) { showMessage(result.message, 'success'); fetchData(); }
                            else showMessage(result.error, 'error');
                        } catch(err) { closeModalElement(loadingModal); showMessage("Gagal: " + err, 'error'); }
                    }
                    fileImage.value = '';
                });
            };
            
            function applyFilter() {
                const val = searchInput.value.toLowerCase();
                const col = filterColumn.value;
                const filtered = allData.filter(item => {
                    if(col === 'all') return Object.values(item).some(v => String(v).toLowerCase().includes(val));
                    return String(item[col] || '').toLowerCase().includes(val);
                });
                renderTable(filtered);
            }
            filterColumn.addEventListener('change', applyFilter);
            searchInput.addEventListener('keyup', applyFilter);

            const formModal = document.getElementById('form-modal');
            const form = document.getElementById('data-form');
            document.getElementById('add-btn').onclick = () => {
                form.reset(); document.getElementById('data-id').value = '';
                document.getElementById('modal-title').textContent = "Tambah Data";
                openModalElement(formModal);
            };
            document.getElementById('close-modal').onclick = () => closeModalElement(formModal);
            document.getElementById('cancel-btn').onclick = () => closeModalElement(formModal);

            form.onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const json = Object.fromEntries(formData.entries());
                const url = json.id ? `/api/tl_tidak_setuju/edit/${json.id}` : `/api/tl_tidak_setuju/add`;
                try {
                    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(json)});
                    if(res.ok) { closeModalElement(formModal); fetchData(); showMessage("Berhasil disimpan", 'success'); }
                    else showMessage("Gagal simpan", 'error');
                } catch(err) { showMessage("Error koneksi", 'error'); }
            };

            window.openEdit = (item) => {
                document.getElementById('data-id').value = item.id;
                ['no_aoi','jenis_aoi','klasifikasi','no_lha','nama_penugasan','auditee','target_per_lha','perubahan_target_date','keterangan','temuan','rekomendasi','tindak_lanjut'].forEach(id => {
                    if(document.getElementById(id)) document.getElementById(id).value = item[id] || '';
                });
                document.getElementById('modal-title').textContent = "Edit Data";
                openModalElement(formModal);
            };

            window.deleteItem = (id) => {
                showConfirm("Hapus data ini?", async (yes) => {
                    if(yes) {
                        await fetch(`/api/tl_tidak_setuju/delete/${id}`, {method:'DELETE'});
                        fetchData();
                        showMessage("Data terhapus", 'success');
                    }
                });
            };

            document.getElementById('delete-all-btn').onclick = () => {
                showConfirm("Apakah Anda yakin untuk menghapus semua data?", (initial_yes) => {
                    if(initial_yes) {
                        showConfirm("Tindakan ini tidak dapat dibatalkan. Yakin?", async (final_yes) => {
                            if(final_yes) {
                                const res = await fetch('/api/tl_tidak_setuju/delete_all', {method:'DELETE'});
                                const result = await res.json();
                                if(res.ok) { showMessage(result.message, 'success'); fetchData(); }
                                else showMessage(result.error, 'error');
                            }
                        });
                    }
                });
            };

            fetchData();
        });
    </script>
</body>
</html>