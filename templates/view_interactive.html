<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Proofread View</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --bg-app: #525659;
            --paper-color: #ffffff;
            --sidebar-bg: #f8f9fa;
            --accent-color: #c0392b;
            --highlight-color: #ffe082;
            --highlight-border: #f39c12;
            --text-dark: #333;
            --green-accept: #2ecc71;
            --red-reject: #e74c3c;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- NAVIGASI ATAS --- */
        .top-nav {
            background: #202124;
            color: white;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 20;
            flex-shrink: 0;
        }

        .nav-left { display: flex; align-items: center; gap: 10px; width: 200px; }
        .nav-center { display: flex; align-items: center; gap: 15px; flex: 1; justify-content: center; }
        .nav-right { display: flex; justify-content: flex-end; width: 200px; }

        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }
        .nav-btn:hover:not(:disabled) { background: rgba(255,255,255,0.3); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        /* Tombol Download Spesifik */
        .btn-download {
            background-color: #27ae60;
            border: none;
            font-weight: 600;
            padding: 8px 16px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn-download:hover { background-color: #219150; transform: translateY(-1px); }

        .page-info { font-weight: 600; font-size: 14px; color: #ddd; min-width: 100px; text-align: center; }

        /* --- LAYOUT UTAMA --- */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden; 
            height: calc(100vh - 60px);
        }

        /* --- AREA DOKUMEN --- */
        .doc-area {
            flex: 1;
            background-color: var(--bg-app);
            overflow-y: auto;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
        }

        .paper {
            background: var(--paper-color);
            width: 210mm;
            min-height: 297mm; 
            padding: 25mm;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            color: #000;
            line-height: 1.6;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            position: relative;
            margin-bottom: 40px; 
        }

        .document-page p { margin-bottom: 12pt; margin-top: 0; }

        /* Highlight Marker */
        .marker {
            background-color: transparent;
            text-decoration: underline;
            text-decoration-style: wavy;
            text-decoration-color: #e74c3c;
            text-decoration-thickness: 1.5px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .marker:hover, .marker.active {
            background-color: #fff176;
            text-decoration: none;
            border-bottom: 2px solid #fbc02d;
            color: #000;
        }
        .marker.fixed {
            background-color: rgba(46, 204, 113, 0.2);
            border-bottom: none;
            text-decoration: none;
            color: #27ae60;
            font-weight: bold;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 400px;
            background: var(--sidebar-bg);
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            z-index: 10;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Kartu Saran */
        .card {
            background: white;
            border-radius: 10px;
            padding: 0;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            opacity: 1;
        }
        
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card.active { border-left-color: #3498db; background-color: #f4faff; border-color: #b3d7ff; }
        .card.fade-out { opacity: 0; transform: translateX(20px); transition: opacity 0.3s, transform 0.3s; }

        .card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .badge-type { background-color: #ffebee; color: #c62828; font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-ignore-sm { background: none; border: none; color: #999; cursor: pointer; padding: 2px; font-size: 16px; transition: color 0.2s; }
        .btn-ignore-sm:hover { color: var(--red-reject); }

        .card-body { padding: 15px; }
        .diff-box { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .txt-ori { color: #c0392b; text-decoration: line-through; background: #f9e7e7; padding: 2px 5px; border-radius: 4px; font-size: 0.95em; }
        .arrow-icon { color: #7f8c8d; font-size: 1.2em; }
        .txt-new { color: #27ae60; font-weight: bold; background: #e8f8f5; padding: 2px 5px; border-radius: 4px; font-size: 0.95em; }

        .card-actions { padding: 10px 15px; background: #fcfcfc; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end; gap: 8px; border-radius: 0 0 10px 10px; }
        .btn-action { border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .btn-accept { background-color: var(--green-accept); color: white; }
        .btn-accept:hover { background-color: #27ae60; box-shadow: 0 2px 5px rgba(46, 204, 113, 0.3); }
        .btn-reject { background-color: white; border: 1px solid #ddd; color: #666; }
        .btn-reject:hover { background-color: #f5f5f5; color: #333; }

        .empty-msg { text-align: center; color: #757575; margin-top: 60px; font-family: sans-serif; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div class="nav-left">
            <div style="font-weight:bold; font-size:16px; display:flex; align-items:center; gap:8px;">
                <i class='bx bxs-edit-alt'></i> Editor Mode
            </div>
        </div>

        <div class="nav-center">
            <button class="nav-btn" id="prev-btn" onclick="changePage(-1)">
                <i class='bx bx-chevron-left'></i> Prev
            </button>
            <span class="page-info" id="page-indicator">Page 1 of 1</span>
            <button class="nav-btn" id="next-btn" onclick="changePage(1)">
                Next <i class='bx bx-chevron-right'></i>
            </button>
        </div>

        <div class="nav-right">
            <button class="nav-btn btn-download" onclick="downloadRevision()">
                <i class='bx bxs-download'></i> Download Revisi
            </button>
        </div>
    </div>

    <div class="main-layout">
        <div class="doc-area">
            <div class="paper" id="paper-content"></div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <h3 style="margin:0; color:#2c3e50; font-size: 1.1rem; display:flex; justify-content:space-between; align-items:center;">
                    Daftar Saran
                    <span style="font-size:0.7em; background:#e0e0e0; padding:2px 8px; border-radius:10px; color:#555;" id="error-count">0 Isu</span>
                </h3>
            </div>
            <div class="sidebar-content" id="sidebar-list"></div>
        </div>
    </div>

    <script>
        let pagesData = [];
        let errorsData = [];
        let currentPageIndex = 0;
        const currentFilename = sessionStorage.getItem('proofreadingFilename');

        document.addEventListener("DOMContentLoaded", () => {
            const pagesRaw = sessionStorage.getItem('proofreadPages');
            const errorsRaw = sessionStorage.getItem('proofreadResults');
            
            if(!pagesRaw) {
                document.getElementById('paper-content').innerHTML = "<p class='empty-msg'>Dokumen tidak ditemukan.</p>";
                return;
            }

            pagesData = JSON.parse(pagesRaw);
            errorsData = JSON.parse(errorsRaw || '[]');
            errorsData.sort((a, b) => b["Kata/Frasa Salah"].length - a["Kata/Frasa Salah"].length);

            renderPage(0);
        });

        // --- FUNGSI DOWNLOAD REVISI BARU ---
        function downloadRevision() {
            if(!currentFilename) {
                alert("Nama file tidak ditemukan. Silakan lakukan analisis ulang.");
                return;
            }
            
            // Redirect ke API download yang baru dibuat
            window.location.href = `/api/download_current_doc?filename=${encodeURIComponent(currentFilename)}`;
        }
        // -----------------------------------

        function changePage(step) {
            const newIndex = currentPageIndex + step;
            if (newIndex >= 0 && newIndex < pagesData.length) {
                renderPage(newIndex);
            }
        }

        function renderPage(index) {
            currentPageIndex = index;
            const paper = document.getElementById('paper-content');
            const sidebar = document.getElementById('sidebar-list');
            const pageIndicator = document.getElementById('page-indicator');
            const errorCountBadge = document.getElementById('error-count');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const docArea = document.querySelector('.doc-area');

            paper.innerHTML = pagesData[index];
            docArea.scrollTop = 0; 

            pageIndicator.textContent = `Page ${index + 1} of ${pagesData.length}`;
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === pagesData.length - 1;

            sidebar.innerHTML = '';
            
            const currentErrors = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = pagesData[index];
            const pageText = tempDiv.textContent;

            errorsData.forEach((err, errIdx) => {
                if (pageText.includes(err["Kata/Frasa Salah"])) {
                    currentErrors.push({ ...err, globalIndex: errIdx });
                }
            });

            errorCountBadge.textContent = `${currentErrors.length} Isu`;

            if (currentErrors.length === 0) {
                sidebar.innerHTML = `
                    <div class='empty-msg'>
                        <i class='bx bx-check-double' style="font-size:48px; color:#2ecc71;"></i><br>
                        Halaman ini bersih!
                    </div>`;
            } else {
                currentErrors.forEach((err) => {
                    const uniqueId = `err-${err.globalIndex}`;
                    highlightText(paper, err["Kata/Frasa Salah"], uniqueId);

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.id = `card-${uniqueId}`;
                    card.onclick = (e) => {
                        if(!e.target.closest('button')) focusMark(uniqueId);
                    };

                    card.innerHTML = `
                        <div class="card-header">
                            <span class="badge-type">TYPO / EJAAN</span>
                            <button class="btn-ignore-sm" title="Abaikan" onclick="ignoreSuggestion('${uniqueId}', '${err["Kata/Frasa Salah"]}')">
                                <i class='bx bx-x'></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="diff-box">
                                <span class="txt-ori">${err["Kata/Frasa Salah"]}</span>
                                <i class='bx bx-right-arrow-alt arrow-icon'></i>
                                <span class="txt-new">${err["Perbaikan Sesuai KBBI"]}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn-action btn-reject" onclick="ignoreSuggestion('${uniqueId}', '${err["Kata/Frasa Salah"]}')">
                                Abaikan
                            </button>
                            <button class="btn-action btn-accept" id="btn-accept-${uniqueId}" onclick="acceptSuggestion('${uniqueId}', '${err["Kata/Frasa Salah"]}', '${err["Perbaikan Sesuai KBBI"]}')">
                                <i class='bx bx-check'></i> Terapkan
                            </button>
                        </div>
                    `;
                    sidebar.appendChild(card);
                });
            }
        }

        async function acceptSuggestion(id, oldText, newText) {
            const btn = document.getElementById(`btn-accept-${id}`);
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = `<i class='bx bx-loader-alt bx-spin'></i> Menyimpan...`;
            }

            try {
                const response = await fetch('/api/apply_fix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filename: currentFilename,
                        old_text: oldText,
                        new_text: newText
                    })
                });

                const result = await response.json();

                if (result.status === 'success' || result.status === 'warning') {
                    const mark = document.getElementById(`mark-${id}`);
                    const card = document.getElementById(`card-${id}`);

                    if (mark) {
                        const fixedSpan = document.createElement('span');
                        fixedSpan.className = 'marker fixed';
                        fixedSpan.textContent = newText;
                        mark.parentNode.replaceChild(fixedSpan, mark);
                        
                        setTimeout(() => {
                            if(fixedSpan.parentNode) {
                                const plainText = document.createTextNode(newText);
                                fixedSpan.parentNode.replaceChild(plainText, fixedSpan);
                                updatePagesData(); 
                            }
                        }, 1500);
                    }

                    if (card) {
                        card.classList.add('fade-out');
                        setTimeout(() => {
                            card.remove();
                            updateCount();
                        }, 300);
                    }
                } else {
                    alert("Gagal menyimpan ke file: " + result.message);
                    if(btn) { btn.disabled = false; btn.innerHTML = `<i class='bx bx-check'></i> Terapkan`; }
                }

            } catch (error) {
                console.error(error);
                alert("Kesalahan koneksi: " + error.message);
                if(btn) { btn.disabled = false; btn.innerHTML = `<i class='bx bx-check'></i> Terapkan`; }
            }
        }

        function ignoreSuggestion(id, wrongText) {
            const mark = document.getElementById(`mark-${id}`);
            const card = document.getElementById(`card-${id}`);

            if (mark) {
                const textNode = document.createTextNode(wrongText);
                mark.parentNode.replaceChild(textNode, mark);
                updatePagesData();
            }

            if (card) {
                card.classList.add('fade-out');
                setTimeout(() => {
                    card.remove();
                    updateCount();
                }, 300);
            }
        }

        function updatePagesData() {
            const paper = document.getElementById('paper-content');
            pagesData[currentPageIndex] = paper.innerHTML;
            sessionStorage.setItem('proofreadPages', JSON.stringify(pagesData));
        }

        function updateCount() {
            const count = document.querySelectorAll('.card:not(.fade-out)').length;
            document.getElementById('error-count').textContent = `${count} Isu`;
            if (count === 0) {
                document.getElementById('sidebar-list').innerHTML = `
                    <div class='empty-msg'>
                        <i class='bx bx-check-double' style="font-size:48px; color:#2ecc71;"></i><br>
                        Halaman ini bersih!
                    </div>`;
            }
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightText(rootElement, searchText, id) {
            const walker = document.createTreeWalker(rootElement, NodeFilter.SHOW_TEXT, null, false);
            const nodesToReplace = [];

            while(walker.nextNode()) {
                const node = walker.currentNode;
                if (node.nodeValue.includes(searchText) && node.parentNode.className !== 'marker') {
                    nodesToReplace.push(node);
                }
            }

            nodesToReplace.forEach(node => {
                const parent = node.parentNode;
                const text = node.nodeValue;
                const regex = new RegExp(escapeRegExp(searchText), 'g');
                
                const newHtml = text.replace(regex, `<span class="marker" id="mark-${id}" onclick="focusCard('${id}')">$&</span>`);
                const spanWrapper = document.createElement('span');
                spanWrapper.innerHTML = newHtml;
                parent.replaceChild(spanWrapper, node);
                
                while (spanWrapper.firstChild) {
                    parent.insertBefore(spanWrapper.firstChild, spanWrapper);
                }
                parent.removeChild(spanWrapper);
            });
        }

        window.focusCard = (id) => {
            resetActive();
            const card = document.getElementById(`card-${id}`);
            const marks = document.querySelectorAll(`#mark-${id}`);
            
            if(card) {
                card.classList.add('active');
                card.scrollIntoView({ behavior: "smooth", block: "center" });
            }
            if(marks.length > 0) {
                marks.forEach(m => {
                    m.classList.add('active');
                    m.scrollIntoView({ behavior: "smooth", block: "center" });
                });
            }
        }

        window.focusMark = (id) => {
            resetActive();
            const card = document.getElementById(`card-${id}`);
            const marks = document.querySelectorAll(`#mark-${id}`);

            if(marks.length > 0) {
                marks.forEach(m => {
                    m.classList.add('active');
                    m.scrollIntoView({ behavior: "smooth", block: "center" });
                });
            }
            if(card) card.classList.add('active');
        }

        function resetActive() {
            document.querySelectorAll('.card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.marker').forEach(el => el.classList.remove('active'));
        }
    </script>
</body>
</html>