<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign PIC SKAI - {{ reminder.subject }}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon-32x32.png') }}" type="image/png">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Poppins', sans-serif; color: #333; margin: 0; }
        .assign-container { background: white; width: 98%; margin: 20px auto; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); box-sizing: border-box; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .page-title h2 { margin: 0; color: #C62828; font-size: 1.6rem; }
        .page-subtitle { color: #666; font-size: 0.9rem; margin-top: 5px; }
        
        .info-box { 
            background: #e3f2fd; 
            padding: 15px 20px; 
            border-radius: 6px; 
            border: 1px solid #bbdefb; 
            margin-bottom: 20px; 
            display: flex; 
            gap: 40px; 
            align-items: flex-start;
        }
        
        .info-item label { 
            display: block; 
            font-size: 0.75rem; 
            color: #555; 
            font-weight: 600; 
            text-transform: uppercase; 
            margin-bottom: 4px;
        }
        
        .info-item div { 
            font-weight: 700; 
            font-size: 1rem; 
            color: #1565c0; 
        }

        .table-responsive { 
            overflow-x: auto; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            max-height: 70vh; 
            position: relative; 
        }
        .assign-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 2400px; 
        }
        .assign-table th, .assign-table td { 
            padding: 12px 15px; 
            border-bottom: 1px solid #eee; 
            vertical-align: middle; 
            white-space: normal; 
            text-align: justify;
        }
        .assign-table th { 
            background-color: #f8f9fa; 
            font-weight: 600; 
            color: #444; 
            text-align: center; 
            border-bottom: 2px solid #ddd; 
            height: 50px; 
        }
        .col-sticky-right { 
            position: sticky; 
            right: 0; 
            z-index: 10; 
            background-color: #fff; 
            border-left: 3px solid #eee; 
            box-shadow: -2px 0 5px rgba(0,0,0,0.05); 
            width: 350px; 
            min-width: 350px; 
            text-align: center; 
        }
        th.col-sticky-right { 
            background-color: #e8f5e9; 
            color: #2e7d32; z-index: 11; 
        }

        /* --- STYLES UNTUK TOMBOL PILIH PIC --- */
        .pic-wrapper {
            display: flex; flex-direction: column; gap: 8px; align-items: stretch;
        }
        .pic-display {
            border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 0.85rem;
            min-height: 38px; background: #fcfcfc; text-align: left;
        }
        .pic-display ol { margin: 0; padding-left: 20px; }
        .pic-display li { margin-bottom: 2px; }
        
        .btn-pilih-pic-row {
            background-color: #1976D2; color: white; border: none; padding: 8px; border-radius: 4px;
            cursor: pointer; font-weight: 600; font-size: 0.85rem; width: 100%; transition: background 0.2s;
        }
        .btn-pilih-pic-row:hover { background-color: #1565C0; }

        .footer-spacer { height: 80px; }
        .sticky-footer { 
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px 0; border-top: 1px solid #ddd; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; display: flex; 
            justify-content: center; 
        }
        .footer-content { width: 98%; display: flex; justify-content: flex-end; gap: 15px; }
        .btn-save-all { 
            background-color: #2e7d32; color: white; padding: 12px 25px;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem; 
        }
        .btn-save-all:hover { background-color: #1b5e20; }
        .btn-back { 
            background-color: #fff; color: #555; border: 1px solid #ccc; 
            padding: 12px 20px; border-radius: 6px; text-decoration: none; 
            font-weight: 600; display: inline-block; 
        }
        .btn-back:hover { background-color: #f5f5f5; }

        /* --- MODAL STYLES --- */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; 
            align-items: center; z-index: 2000; 
        }
        .hidden { display: none !important; }
        
        .success-modal-content { 
            background-color: white; padding: 30px; border-radius: 12px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 90%; max-width: 400px; 
            animation: slideDown 0.3s ease-out; 
        }
        .success-icon { font-size: 50px; color: #2e7d32; margin-bottom: 15px; }
        .success-title { font-size: 1.4rem; font-weight: 700; color: #333; margin: 0 0 10px 0; }
        .success-message { color: #666; margin-bottom: 25px; font-size: 0.95rem; }
        .btn-success-ok { 
            background-color: #2e7d32; color: white; border: none; padding: 10px 30px; 
            border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1rem; width: 100%; 
        }
        .btn-success-ok:hover { background-color: #1b5e20; }

        /* --- PIC SELECTION MODAL --- */
        .pic-modal-content {
            background-color: white; padding: 2rem; border-radius: 12px; width: 600px; max-width: 90%;
            display: flex; flex-direction: column; max-height: 85vh; position: relative;
            z-index: 3100;
        }
        .modal-close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
        .modal-close-btn:hover { color: #333; }
        
        .pic-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .pic-table th, .pic-table td { padding: 10px 15px; border-bottom: 1px solid #eee; text-align: center; }
        .pic-table th { background-color: #f9f9f9; font-weight: 600; color: #555; position: sticky; top: 0; z-index: 5; }
        .pic-table tr:last-child td { border-bottom: none; }
        .pic-table tr:hover { background-color: #f0f7ff; }
        .pic-table input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        
        .sortable { cursor: pointer; position: relative; }
        .sortable:hover { background-color: #f1f1f1; }
        .sort-icon { margin-left: 5px; font-size: 0.8em; color: #999; }
        
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    {% set allowed_pic_list = (reminder.pic_skai or '').split(',') | map('trim') | list %}
    <script id="allowed-pics-data" type="application/json">
        {{ allowed_pic_list | tojson }}
    </script>

    <div class="assign-container">
        <div class="page-header">
            <div class="page-title">
                <h2>Assign Penugasan (PIC SKAI)</h2>
                <div class="page-subtitle">
                    Tentukan PIC SKAI untuk setiap temuan di bawah ini agar muncul di dashboard mereka.
                </div>
            </div>
        </div>

        <div class="info-box">
            <div class="info-item">
                <label>Auditee</label>
                <div>{{ reminder.assigned_to }}</div>
            </div>
            <div class="info-item">
                <label>Perihal</label>
                <div>{{ reminder.subject }}</div>
            </div>
            <div class="info-item">
                <label>Total Temuan</label>
                <div>{{ rows|length }} Data</div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="assign-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">No</th>
                        <th style="min-width: 100px;">No AOI</th>
                        <th style="min-width: 120px;">Jenis</th>
                        <th style="min-width: 120px;">Klasifikasi</th>
                        <th style="min-width: 200px;">No LHA</th>
                        <th style="min-width: 250px;">Nama Penugasan</th>
                        <th style="min-width: 350px;">AOI</th>
                        <th style="min-width: 350px;">Rekomendasi</th>
                        <th style="min-width: 150px;">Auditee Asal</th>
                        <th style="min-width: 250px;">PIC Reminder</th>
                        <th style="min-width: 200px;">Dibuat Oleh</th>
                        <th class="col-sticky-right">ASSIGN PIC SKAI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr>
                        <td style="text-align: center;">{{ loop.index }}</td>
                        <td style="text-align: center;">{{ row.no_aoi or '-' }}</td>
                        <td style="text-align: center;">{{ row.jenis_aoi or '-' }}</td>
                        <td style="text-align: center;">{{ row.klasifikasi or '-' }}</td>
                        <td style="text-align: justify;">{{ row.no_lha or '-' }}</td>
                        <td>{{ row.nama_penugasan or '-' }}</td>
                        <td><div style="max-height: 80px; overflow-y: auto; font-size: 0.85rem;">{{ row.aoi or '-' }}</div></td>
                        <td><div style="max-height: 80px; overflow-y: auto; font-size: 0.85rem;">{{ row.rekomendasi or '-' }}</div></td>
                        <td style="text-align: center;">{{ row.auditee }}</td>
                        <td><div style="max-height: 80px; overflow-y: auto; font-size: 0.85rem;">{{ row.pic_reminder or '-' }}</div></td>
                        <td style="text-align: center;">{{ row.dibuat_oleh or '-' }}</td>

                        <td class="col-sticky-right">
                            <div class="pic-wrapper">
                                <input type="hidden" class="pic-hidden-value" data-row-id="{{ row.id }}" value="{{ row.pic_skai or '' }}">
                                
                                <div class="pic-display" id="pic-display-{{ row.id }}">
                                    <span style="color:#999; font-style:italic;">Memuat...</span>
                                </div>
                                
                                <button type="button" class="btn-pilih-pic-row" data-id="{{ row.id }}">Pilih PIC</button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 30px;">
                            Tidak ada data temuan yang ditautkan.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer-spacer"></div>

    <div class="sticky-footer">
        <div class="footer-content">
            <a href="{{ url_for('ams_reminder_page') }}" class="btn-back">Kembali</a>
            <button id="btn-save-changes" class="btn-save-all">Simpan Semua Perubahan</button>
        </div>
    </div>

    <div id="success-modal" class="modal hidden">
        <div class="success-modal-content">
            <div class="success-icon">&#10004;</div>
            <h3 class="success-title">Berhasil Disimpan!</h3>
            <p class="success-message">Penugasan PIC SKAI telah berhasil diperbarui dan tersimpan di database.</p>
            <button class="btn-success-ok" onclick="redirectBack()">OK, Kembali ke Menu</button>
        </div>
    </div>

    <div id="pic-selection-modal" class="modal hidden">
        <div class="pic-modal-content">
            <span class="modal-close-btn" onclick="closePicModal()">&times;</span>
            <h3 style="margin-bottom: 10px; color: #C62828;">Pilih PIC SKAI</h3>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Pilih satu atau lebih PIC yang bertanggung jawab.</p>
            
            <div style="margin-bottom: 15px;">
                <input type="text" id="search-pic-input" placeholder="Cari nama PIC..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
            </div>

            <div style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 0;">
                <table class="pic-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;"><input type="checkbox" id="select-all-pic"></th>
                            <th data-sort-key="name" class="sortable pic-sort">Nama <span class="sort-icon"></span></th>
                            <th data-sort-key="label" class="sortable pic-sort">Label <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="pic-list-body">
                        </tbody>
                </table>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-back" onclick="closePicModal()" style="border:1px solid #ccc; font-weight:normal; font-size:0.9rem;">Batal</button>
                <button type="button" class="btn-save-all" id="save-pic-selection-btn" style="padding:10px 20px; font-size:0.9rem;">Simpan Pilihan</button>
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];
        let currentRowId = null;
        let lastPicSortKey = 'name';
        let lastPicSortDirection = 'asc';
        
        // Baca data allowed list dari tag script JSON
        const allowedPicsData = document.getElementById('allowed-pics-data');
        const ALLOWED_PICS = allowedPicsData ? JSON.parse(allowedPicsData.textContent) : [];

        // Load users from backend
        async function loadUsers() {
            try {
                const res = await fetch('/api/get_all_users');
                if (res.ok) {
                    const data = await res.json();
                    
                    // Filter berdasarkan daftar PIC yang diizinkan (dari Reminder)
                    allUsers = data.filter(u => {
                        return ALLOWED_PICS.includes(u.username) || ALLOWED_PICS.includes(u.fullname);
                    });
                    
                    // Sort by name initially
                    allUsers.sort((a, b) => a.fullname.localeCompare(b.fullname));

                    // Init display for all rows
                    document.querySelectorAll('.pic-hidden-value').forEach(input => {
                        updatePicDisplay(input.dataset.rowId, input.value);
                    });
                }
            } catch (e) {
                console.error("Gagal load user", e);
            }
        }

        function updatePicDisplay(rowId, valueString) {
            const displayEl = document.getElementById(`pic-display-${rowId}`);
            if (!valueString) {
                displayEl.innerHTML = '<span style="color:#999; font-style:italic;">Belum ada PIC</span>';
                return;
            }

            const usernames = valueString.split(',').map(s => s.trim()).filter(s => s);
            if (usernames.length === 0) {
                displayEl.innerHTML = '<span style="color:#999; font-style:italic;">Belum ada PIC</span>';
            } else if (usernames.length === 1) {
                // Single PIC
                const user = allUsers.find(u => u.username === usernames[0]);
                displayEl.textContent = user ? user.fullname : usernames[0];
            } else {
                // Multiple PIC (Numbered List)
                let html = '<ol>';
                usernames.forEach(uname => {
                    const user = allUsers.find(u => u.username === uname);
                    html += `<li>${user ? user.fullname : uname}</li>`;
                });
                html += '</ol>';
                displayEl.innerHTML = html;
            }
        }

        // --- MODAL LOGIC ---
        function openPicModalFor(rowId) {
            currentRowId = rowId;
            const currentVal = document.querySelector(`.pic-hidden-value[data-row-id="${rowId}"]`).value;
            const currentSelection = currentVal ? currentVal.split(',').map(s => s.trim()) : [];

            renderPicList(currentSelection);

            // Reset search & select all
            document.getElementById('search-pic-input').value = '';
            document.getElementById('select-all-pic').checked = false;
            sortPicTable(lastPicSortKey); // Default sort

            document.getElementById('pic-selection-modal').classList.remove('hidden');
        }

        function renderPicList(currentSelection) {
            const tbody = document.getElementById('pic-list-body');
            tbody.innerHTML = '';

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">Tidak ada data PIC yang tersedia.</td></tr>';
                return;
            }

            allUsers.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'pic-list-item';
                tr.dataset.username = u.username;
                tr.dataset.name = u.fullname.toLowerCase();
                tr.dataset.label = u.label.toLowerCase();

                // Checkbox
                const tdCheck = document.createElement('td');
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = u.username;
                cb.className = 'pic-item-checkbox';
                if (currentSelection.includes(u.username)) cb.checked = true;
                
                // Click row to toggle
                tr.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        cb.checked = !cb.checked;
                    }
                };

                tdCheck.appendChild(cb);
                tr.appendChild(tdCheck);

                // Name
                const tdName = document.createElement('td');
                tdName.textContent = u.fullname;
                tr.appendChild(tdName);

                // Label
                const tdLabel = document.createElement('td');
                tdLabel.textContent = u.label;
                tr.appendChild(tdLabel);

                tbody.appendChild(tr);
            });
        }

        function sortPicTable(key) {
            // Reset icons
            document.querySelectorAll('.pic-table th.sortable').forEach(h => {
                h.classList.remove('asc', 'desc');
                h.querySelector('.sort-icon').textContent = '';
            });

            const isAscending = lastPicSortKey !== key || lastPicSortDirection === 'desc';
            const direction = isAscending ? 'asc' : 'desc';
            
            const currentHeader = document.querySelector(`.pic-table th[data-sort-key="${key}"]`);
            if (currentHeader) {
                currentHeader.classList.add(direction);
                currentHeader.querySelector('.sort-icon').textContent = isAscending ? '▲' : '▼';
            }

            const tbody = document.getElementById('pic-list-body');
            const rows = Array.from(tbody.querySelectorAll('tr.pic-list-item'));

            rows.sort((a, b) => {
                const valA = a.dataset[key];
                const valB = b.dataset[key];
                if (valA < valB) return isAscending ? -1 : 1;
                if (valA > valB) return isAscending ? 1 : -1;
                return 0;
            });

            rows.forEach(row => tbody.appendChild(row));
            
            lastPicSortKey = key;
            lastPicSortDirection = direction;
        }

        function closePicModal() {
            document.getElementById('pic-selection-modal').classList.add('hidden');
            currentRowId = null;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();

            // EVENT DELEGATION
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('btn-pilih-pic-row')) {
                    const id = e.target.getAttribute('data-id');
                    openPicModalFor(id);
                }
            });

            // Save Selection from Modal
            document.getElementById('save-pic-selection-btn').addEventListener('click', () => {
                if (currentRowId === null) return;
                
                const checkboxes = document.querySelectorAll('.pic-item-checkbox:checked');
                const selectedUsernames = Array.from(checkboxes).map(cb => cb.value);
                const newValue = selectedUsernames.join(',');

                // Update hidden input & display
                const hiddenInput = document.querySelector(`.pic-hidden-value[data-row-id="${currentRowId}"]`);
                hiddenInput.value = newValue;
                updatePicDisplay(currentRowId, newValue);

                closePicModal();
            });

            // Search Filter
            document.getElementById('search-pic-input').addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#pic-list-body tr.pic-list-item').forEach(row => {
                    const txtName = row.dataset.name;
                    const txtLabel = row.dataset.label;
                    row.style.display = (txtName.includes(term) || txtLabel.includes(term)) ? '' : 'none';
                });
            });

            // Select All
            document.getElementById('select-all-pic').addEventListener('change', (e) => {
                document.querySelectorAll('.pic-item-checkbox').forEach(cb => {
                    if (cb.closest('tr').style.display !== 'none') {
                        cb.checked = e.target.checked;
                    }
                });
            });

            // Sorting Headers
            document.querySelectorAll('.pic-table th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const key = this.getAttribute('data-sort-key');
                    sortPicTable(key);
                });
            });

            // Save All Changes to Server
            const btnSave = document.getElementById('btn-save-changes');
            const successModal = document.getElementById('success-modal');

            if (btnSave) {
                btnSave.addEventListener('click', async () => {
                    const inputs = document.querySelectorAll('.pic-hidden-value');
                    const updates = [];
                    inputs.forEach(inp => {
                        updates.push({
                            id: inp.dataset.rowId,
                            pic_skai: inp.value
                        });
                    });

                    if (updates.length === 0) return;
                    
                    btnSave.textContent = "Menyimpan...";
                    btnSave.disabled = true;

                    try {
                        const response = await fetch('/api/update_linked_pic_skai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ updates: updates })
                        });

                        if (response.ok) {
                            successModal.classList.remove('hidden');
                        } else {
                            const err = await response.json();
                            alert("Gagal menyimpan: " + err.error);
                            btnSave.textContent = "Simpan Semua Perubahan";
                            btnSave.disabled = false;
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Terjadi kesalahan koneksi.");
                        btnSave.textContent = "Simpan Semua Perubahan";
                        btnSave.disabled = false;
                    }
                });
            }
        });

        function redirectBack() {
            window.location.href = "{{ url_for('ams_reminder_page') }}";
        }
    </script>
</body>
</html>