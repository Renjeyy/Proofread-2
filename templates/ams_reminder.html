<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta 
        name="viewport" 
        content="width=device-width, initial-scale=1.0"
    >
    <title>Reminder Tindak Lanjut</title>
    
    <link 
        rel="preconnect" 
        href="https://fonts.googleapis.com"
    >
    <link 
        rel="preconnect" 
        href="https://fonts.gstatic.com" 
        crossorigin
    >
    <link 
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;700&display=swap" 
        rel="stylesheet"
    >
    <!-- Tambahkan Boxicons untuk icon sidebar -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <link 
        rel="stylesheet" 
        href="{{ url_for('static', filename='style.css') }}" 
    >
    <link 
        rel="icon" 
        href="{{ url_for('static', filename='favicon-32x32.png') }}" 
        type="image/png"
    >
    
    <style>
        /* === SIDEBAR & LAYOUT STYLES === */
        :root {
            /* Warna Sidebar & Layout */
            --primary-color: #C62828;
            --primary-hover: #B71C1C;
            --primary-light: #FFEBEE;
            --active-bg: #E3F2FD;
            --active-text: #1565C0;
            --secondary-bg: #F4F7FE;
            --sidebar-width: 290px;
            --sidebar-collapsed-width: 85px;
            --text-dark: #2B3674;
            --text-gray: #A3AED0;
            --text-light-gray: #707EAE;
            --white: #FFFFFF;
            --border-color: #E0E5F2;

            /* Warna Asli Reminder */
            --secondary-color: green;
            --secondary-hover: #1b5e20;
            --text-color: #333;
            --text-muted: #666;
            --bg-light: #f8f9fa;
            
            --status-overdue-bg: #FFEBEE; 
            --status-overdue-text: #C62828;
            --status-today-bg: #FFF9C4;       
            --status-today-text: #F57F17;
            --status-ok-bg: #E8F5E9;        
            --status-ok-text: #2E7D32;
            
            --badge-company-bg: #E3F2FD;  
            --badge-company-text: #1565C0; 
            --badge-company-border: #BBDEFB;
        }

        * { 
            box-sizing: border-box; 
        }

        body { 
            font-family: 'DM Sans', 'Poppins', sans-serif; 
            color: var(--text-color);
            margin: 0;
            background-color: var(--secondary-bg); /* Menggunakan background dashboard */
            display: block; /* Pastikan block untuk layout sidebar */
            min-height: 100vh;
            font-size: 0.9rem;
        }

        /* === SIDEBAR STYLES === */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-sizing: border-box;
            border-right: 1px solid var(--border-color);
            z-index: 3000;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #ddd transparent;
            transition: width 0.3s ease, padding 0.3s ease;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
            padding: 24px 12px;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background-color: #ddd;
            border-radius: 3px;
        }

        .sidebar-toggle-btn {
            position: absolute;
            top: 25px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
            color: var(--text-gray);
            z-index: 3002;
            transition: right 0.3s ease;
        }
        
        .sidebar.collapsed .sidebar-toggle-btn {
            right: 50%;
            transform: translateX(50%);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            min-height: 50px;
            position: relative;
        }

        .sidebar-logo img {
            max-width: 100px;
            height: auto;
            transition: opacity 0.2s;
        }

        .sidebar.collapsed .sidebar-logo img {
            opacity: 0;
            pointer-events: none;
            display: none;
        }

        .nav-links {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .nav-links li {
            width: 100%;
        }

        .nav-section-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 16px;
            margin-bottom: 8px;
            padding-left: 12px;
            display: block;
            white-space: nowrap;
            transition: opacity 0.2s;
        }

        .sidebar.collapsed .nav-section-label {
            display: none;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-light-gray);
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
        }

        .nav-links a i {
            font-size: 22px;
            margin-right: 14px;
            color: var(--text-gray);
            transition: margin 0.3s ease, color 0.2s;
            min-width: 22px;
        }

        .sidebar.collapsed .nav-links a {
            justify-content: center;
            padding: 12px;
        }
        
        .sidebar.collapsed .nav-links a i {
            margin-right: 0;
        }
        
        .sidebar.collapsed .nav-links a span {
            display: none;
        }

        .nav-links a:hover {
            background-color: var(--secondary-bg);
            color: var(--text-dark);
        }
        
        .nav-links a:hover i {
            color: var(--primary-color);
        }

        .nav-links a.active {
            background-color: var(--active-bg);
            color: var(--active-text);
            font-weight: 700;
        }
        
        .nav-links a.active i {
            color: var(--active-text);
        }

        .sidebar-footer {
            margin-top: 20px;
        }

        .user-card {
            background: linear-gradient(135deg, #C62828 0%, #B71C1C 100%);
            padding: 16px;
            border-radius: 16px;
            color: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 10px 20px rgba(198, 40, 40, 0.2);
            transition: padding 0.3s;
            overflow: hidden;
        }

        .sidebar.collapsed .user-card {
            padding: 12px;
            align-items: center;
            background: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar.collapsed .user-info {
            gap: 0;
            justify-content: center;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            white-space: nowrap;
        }

        .sidebar.collapsed .user-details {
            display: none;
        }

        .user-name {
            font-size: 14px;
            font-weight: 700;
        }

        .user-role {
            font-size: 11px;
            opacity: 0.8;
        }

        .logout-link {
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sidebar.collapsed .logout-link span {
            display: none;
        }
        
        .sidebar.collapsed .logout-link {
            padding: 8px 0;
            margin-top: 5px;
        }

        .logout-link:hover {
            background: rgba(255,255,255,0.2);
        }

        /* === MAIN CONTENT ADJUSTMENT === */
        main, .monitoring-main { 
            margin-left: var(--sidebar-width) !important; 
            width: auto !important; 
            max-width: 100% !important;
            padding: 30px; 
            box-sizing: border-box;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }

        main.expanded, .monitoring-main.expanded {
            margin-left: var(--sidebar-collapsed-width) !important;
        }

        footer {
            margin-top: auto;
            background-color: var(--secondary-bg);
            padding: 10px 0;
            text-align: center;
            color: #999;
            font-size: 0.75rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* === CONTENT STYLES ASLI (Dipertahankan) === */
        .monitoring-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 15px; 
        }

        .monitoring-header h1 { 
            margin: 0; 
            font-size: 1.8rem; 
            color: var(--text-dark); /* Menggunakan warna dari tema baru */
            font-weight: 700; 
        }

        .start-btn { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.95rem; 
            box-shadow: 0 4px 6px rgba(198, 40, 40, 0.2); 
            transition: transform 0.2s; 
        }

        .start-btn:hover { 
            transform: translateY(-2px); 
            background-color: #b71c1c; 
        }

        .controls-container { 
            display: flex; 
            justify-content: flex-end; 
            gap: 1rem; 
            margin-bottom: 1rem; 
        }

        .data-table-container { 
            margin-bottom: 3rem; 
        }
        
        .list-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid #eee; 
            padding-bottom: 1rem; 
            margin-bottom: 1rem;
        }

        .hidden { 
            display: none !important; 
        }

        .action-btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 600; 
            transition: all 0.2s ease-in-out; 
            font-family: 'Poppins', sans-serif; 
        }

        .btn-save { 
            background-color: var(--secondary-color); 
            color: white; 
        }

        .btn-save:hover { 
            background-color: var(--secondary-hover); 
            transform: translateY(-1px); 
        }

        .btn-edit { 
            background-color: #1976D2; 
            color: white; 
        }

        .btn-edit:hover { 
            background-color: #1565C0; 
        }

        .btn-delete { 
            background-color: #d32f2f; 
            color: white; 
        }

        .btn-delete:hover { 
            background-color: #b71c1c; 
        }

        .btn-view-temuan { 
            background-color: #2e7d32; 
            color: white; 
            padding: 6px 12px; 
            border-radius: 6px; 
            text-decoration: none; 
            font-weight: 600; 
            font-size: 0.85rem; 
            display: inline-flex; 
            align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            transition: background 0.2s; 
        }

        .btn-view-temuan:hover { 
            background-color: #1b5e20; 
            transform: translateY(-1px); 
        }
        
        .btn-input-temuan { 
            background: #fff; 
            border: 1px dashed #999; 
            color: var(--text-muted); 
            padding: 6px 10px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
            width: 100%; 
            transition: all 0.2s; 
            font-family: 'Poppins', sans-serif; 
        }

        .btn-input-temuan:hover { 
            background-color: #f5f5f5; 
            border-color: var(--text-color); 
            color: var(--text-color); 
        }

        .btn-share-cancel { 
            flex: 1; 
            background: #fff; 
            border: 1px solid #ccc; 
            padding: 10px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight:600; 
            color:#555; 
            font-family: 'Poppins', sans-serif; 
        }

        .btn-share-submit { 
            flex: 1; 
            background: #D32F2F; 
            color: white; 
            border: none; 
            padding: 10px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight:600; 
            font-family: 'Poppins', sans-serif; 
        }

        .custom-input, 
        .btn-select-pic, 
        .form-group input, 
        .form-group select { 
            width: 100%; 
            height: 40px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            background-color: white; 
            font-family: 'Poppins', sans-serif; 
            font-size: 0.9rem; 
            box-sizing: border-box; 
            color: #333; 
            outline: none; 
            transition: border-color 0.2s; 
        }

        .btn-select-pic, 
        .form-group input, 
        input.custom-input { 
            display: flex; 
            align-items: center; 
            padding: 0 12px; 
        }

        .btn-select-pic { 
            justify-content: space-between; 
            cursor: pointer; 
            text-align: left; 
        }

        .form-group select, 
        select.custom-input { 
            display: block !important; 
            padding: 0 35px 0 12px !important; 
            line-height: 38px !important; 
            cursor: pointer; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none; 
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); 
            background-repeat: no-repeat; 
            background-position: right 12px center; 
            background-size: 10px auto; 
        }

        .form-group input:focus, 
        .form-group select:focus { 
            border-color: #1976D2; 
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1); 
        }

        .btn-select-pic:disabled { 
            background-color: #f5f5f5; 
            cursor: not-allowed; 
            border-color: #ddd; 
            color: #999; 
        }

        .badge { 
            padding: 5px 10px; 
            border-radius: 6px; 
            font-weight: 700; 
            font-size: 0.8em; 
            display: inline-block; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }

        .status-badge { 
            padding: 6px 12px; 
            border-radius: 8px; 
            font-weight: 800; 
            font-size: 0.8em; 
            display: inline-block; 
            letter-spacing: 0.5px; 
            text-transform: uppercase; 
            white-space: nowrap; 
        }

        .badge-company { 
            background-color: var(--badge-company-bg); 
            color: var(--badge-company-text); 
            border: 1px solid var(--badge-company-border); 
            font-size: 0.9rem; 
            padding: 4px 12px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            text-transform: none !important; 
            font-weight: 600; 
            border-radius: 6px; 
            display: inline-block; 
        }

        .badge-count { 
            background: #fff; 
            color: #2e7d32; 
            border-radius: 10px; 
            padding: 1px 6px; 
            font-size: 0.75em; 
            margin-left: 5px; 
            font-weight: 800; 
        }

        .results-table-wrapper { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            margin-bottom: 2rem; 
            background: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }

        .monitoring-data-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1200px; 
        }

        .monitoring-data-table th, 
        .monitoring-data-table td { 
            white-space: nowrap; 
            vertical-align: middle; 
            padding: 14px 16px; 
            border-bottom: 1px solid #f0f0f0; 
        }

        .monitoring-data-table th { 
            background-color: var(--bg-light); 
            font-weight: 700; 
            color: #555; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            border-bottom: 2px solid #eee; 
        }

        .col-company { 
            min-width: 100px; 
            text-align: center; 
        }

        .col-auditee { 
            min-width: 180px; 
            max-width: 300px; 
            white-space: normal; 
        }
        
        .col-pic { 
            min-width: 150px; 
            white-space: nowrap; 
        }
        
        .col-temuan { 
            min-width: 100px; 
            text-align: center; 
        }

        .col-checkbox { 
            text-align: center; 
        }

        .modal { 
            z-index: 3005; /* Diatas sidebar */ 
        }

        .box-layout-modal { 
            width: 600px !important; 
            max-width: 95vw; 
            padding: 2rem !important; 
            border-radius: 12px; 
            max-height: 85vh; 
            overflow-y: auto; 
        }

        .form-grid-wrapper { 
            display: flex; 
            flex-direction: column; 
            gap: 2px !important; 
            margin-bottom: 10px; 
        }

        .form-group { 
            margin-bottom: 0; 
        }

        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: var(--text-color); 
            font-size: 0.9rem; 
        }

        .modal-actions { 
            margin-top: 2rem; 
            display: flex; 
            justify-content: flex-end; 
            gap: 1rem; 
        }

        .share-table-wrapper { 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            border-radius: 6px; 
        }

        .share-table { 
            width: 100%; 
            border-collapse: collapse; 
        }

        .share-table th { 
            position: sticky; 
            top: 0; 
            background: #f8f9fa; 
            text-align: center !important; 
            padding: 12px; 
            border-bottom: 2px solid #eee; 
        }

        .share-table td { 
            text-align: center !important; 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            vertical-align: middle; 
        }

        .share-header { 
            padding: 20px 25px 10px; 
            text-align: center; 
            background: #fff; 
            border-bottom: 1px solid #eee; 
        }

        .share-header h3 { 
            color: var(--primary-color); 
            margin: 0 0 5px; 
            font-size: 1.4rem; 
            border: none; 
        }

        .share-footer { 
            padding: 15px 25px 20px; 
            background: #fff; 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #eee; 
        }

        .share-close-x { 
            position: absolute; 
            top: 15px; 
            right: 20px; 
            font-size: 24px; 
            cursor: pointer; 
            color: #aaa; 
            z-index: 5; 
            line-height: 1; 
        }
        
        #user-selection-modal .modal-content {
            width: 700px;
            max-width: 95vw;
        }

        .notif-header { 
            text-align: center; 
            margin-bottom: 1.5rem; 
        }

        .notif-icon { 
            font-size: 3rem; 
            color: var(--secondary-color); 
            margin-bottom: 1rem; 
        }

        .notif-text { 
            font-size: 1.1rem; 
            color: #333; 
            line-height: 1.6; 
            text-align: center; 
            margin-bottom: 2rem; 
        }
        
        #user-selection-modal, 
        #tembusan-selection-modal { 
            z-index: 2500; 
        } 

        #deadline-notification-modal { 
            z-index: 3000; 
        }

        #user-search-container { 
            padding: 0 25px 15px; 
            background: #fff; 
            border-bottom: 1px solid #eee; 
        }

        #user-search-input, 
        #tembusan-search-input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-family: 'Poppins', sans-serif; 
        }

        .sla-badge { 
            padding: 5px 10px; 
            border-radius: 4px; 
            font-weight: 700; 
            font-size: 0.8em; 
            display: inline-block; 
            text-transform: uppercase; 
            white-space: nowrap; 
        }

        .sla-safe { 
            background-color: #E8F5E9; 
            color: #2E7D32; 
            border: 1px solid #C8E6C9; 
        }

        .sla-warning-1 { 
            background-color: #FFF3E0; 
            color: #E65100; 
            border: 1px solid #FFE0B2; 
            animation: pulse-warning 2s infinite; 
        }

        .sla-overdue { 
            background-color: #FFEBEE; 
            color: #D32F2F; 
            border: 1px solid #FFCDD2; 
            font-weight: 800; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
        }

        @keyframes pulse-warning { 
            0% { opacity: 1; } 
            50% { opacity: 0.7; } 
            100% { opacity: 1; } 
        }

        .empty-dashboard { 
            text-align: center; 
            padding: 80px 20px; 
            background-color: #fdfdfd; 
            border: 2px dashed #e0e0e0; 
            border-radius: 12px; 
            margin-top: 2rem; 
        }

        .empty-dashboard h3 { 
            color: #888; 
            font-weight: 500; 
            font-size: 1.2rem; 
            margin: 0; 
        }

        .empty-dashboard p { 
            color: #aaa; 
            font-size: 0.95rem; 
            margin-top: 10px; 
        }

        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            outline: none;
            box-sizing: border-box;
            color: #333;
            resize: vertical; 
            margin: 0 !important;
        }

        .form-group textarea:focus {
            border-color: #1976D2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .no-transition {
            transition: none !important;
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            const toggleBtn = document.querySelector('.sidebar-toggle-btn i');
            const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';

            if (isCollapsed) {
                sidebar.classList.add('no-transition');
                main.classList.add('no-transition');
                sidebar.classList.add('collapsed');
                main.classList.add('expanded');
                if(toggleBtn) toggleBtn.className = 'bx bx-right-arrow-alt';
                setTimeout(() => {
                    sidebar.classList.remove('no-transition');
                    main.classList.remove('no-transition');
                }, 100); 
            }
        });

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            const toggleBtn = document.querySelector('.sidebar-toggle-btn i');
            sidebar.classList.toggle('collapsed');
            main.classList.toggle('expanded');
            const isCollapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebar-collapsed', isCollapsed);
            
            if (isCollapsed) {
                toggleBtn.className = 'bx bx-right-arrow-alt';
            } else {
                toggleBtn.className = 'bx bx-menu';
            }
        }
    </script>
</head>
<body>
    <input 
        type="hidden" 
        id="current-username" 
        value="{{ username }}"
    >

    <!-- SIDEBAR NAVIGATION -->
    <nav class="sidebar">
        <div class="sidebar-toggle-btn" onclick="toggleSidebar()">
            <i class='bx bx-menu'></i>
        </div>

        <div class="sidebar-logo">
            <a href="{{ url_for('dashboard') }}">
                <img src="{{ url_for('static', filename='Logo_IFG-removebg-preview.png') }}" alt="Logo IFG">
            </a>
        </div>
        
        <ul class="nav-links">
            <li>
                <a href="{{ url_for('dashboard') }}">
                    <i class='bx bxs-home-alt-2'></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <span class="nav-section-label">Analisis Dokumen</span>
            
            <li>
                <a href="{{ url_for('dashboard') }}#folder-management">
                    <i class='bx bxs-folder'></i>
                    <span>Folder Saya</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('dashboard') }}#fitur">
                    <i class='bx bxs-magic-wand'></i>
                    <span>Proofread & Tools</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('log_analysis_page') }}">
                    <i class='bx bxs-time-five'></i>
                    <span>Log Analisis</span>
                </a>
            </li>

            <span class="nav-section-label">Tindak Lanjut</span>

            <li>
                <a href="{{ url_for('monitoring_ams_page') }}">
                    <i class='bx bxs-bar-chart-alt-2'></i>
                    <span>Rekap Monitoring</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('ams_temuan_page') }}">
                    <i class='bx bxs-file-find'></i>
                    <span>Temuan</span>
                </a>
            </li>
            <li>
                <!-- MENU INI YANG AKTIF (Reminder) -->
                <a href="{{ url_for('ams_reminder_page') }}" class="active">
                    <i class='bx bxs-bell-ring'></i>
                    <span>Reminder</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('ams_tl_tidak_setuju_page') }}">
                    <i class='bx bxs-x-circle'></i>
                    <span>TL Tidak Setuju</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('ams_auditors_page') }}">
                    <i class='bx bxs-user-badge'></i>
                    <span>Auditors</span>
                </a>
            </li>

            <span class="nav-section-label">Lainnya</span>

            <li>
                <a href="{{ url_for('mailbox_page') }}">
                    <i class='bx bxs-envelope'></i>
                    <span>Email</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('library_page') }}">
                    <i class='bx bxs-book-bookmark'></i>
                    <span>Library</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('settings_page') }}">
                    <i class='bx bxs-cog'></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <div class="user-card">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class='bx bxs-user'></i>
                    </div>
                    <div class="user-details">
                        <span class="user-name">{{ current_user.fullname }}</span>
                        <span class="user-role">{{ current_user.label }}</span>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-link">
                    <i class='bx bx-log-out'></i> <span>Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Gunakan kelas monitoring-main agar tetap sesuai dengan style spesifik Anda -->
    <main class="monitoring-main">
        <section class="monitoring-header">
            <h1>Daftar Reminder Tindak Lanjut</h1>
            <button 
                id="add-reminder-btn" 
                class="start-btn"
            >
                Buat Reminder Baru
            </button>
        </section>

        <div 
            id="loading-indicator" 
            class="loading hidden" 
            style="text-align: center; padding: 2rem;"
        >
            <div class="spinner" style="margin: 0 auto 10px auto;"></div>
            <span style="color: var(--primary-color);">Sedang memuat data...</span>
        </div>
        
        <section 
            class="data-table-container" 
            id="warning-section" 
            style="display: none;"
        >
            <div 
                class="list-header" 
                style="background-color: #fff3e0; border: 1px solid #ffe0b2; border-radius: 8px; padding: 15px; margin-bottom: 15px;"
            >
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                    <div>
                        <h3 style="margin: 0; color: #e65100;">Reminder Warning (Khusus PIC Auditee)</h3>
                        <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;">
                            Daftar tugas yang ditujukan kepada Anda ({{ fullname }}). Harap segera respon kepada PIC SKAI yang terlampir pada tabel berikut.
                        </p>
                    </div>
                </div>
            </div>
            <div 
                class="results-table-wrapper" 
                style="border: 2px solid #ffe0b2;"
            >
                <table class="monitoring-data-table">
                    <thead style="background-color: #fff8e1;">
                        <tr>
                            <th>No</th>
                            <th>Perihal</th>
                            <th class="col-pic">PIC SKAI</th>
                            <th>Deadline</th>
                            <th>Status</th>
                            <th>SLA</th>
                            <th class="col-checkbox">Respond</th>
                            <th style="text-align:center;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="warning-tbody"></tbody>
                </table>
            </div>
        </section>

        {% if label == 'CoE' or label == 'Advisory' %}
        
        <section class="data-table-container">
            <div class="list-header">
                <h3 style="margin: 0; color: var(--primary-color);">Past Reminders (Overdue)</h3>
                <div 
                    class="controls-container" 
                    style="margin-bottom: 0;"
                >
                    <select 
                        id="past-filter-dropdown" 
                        class="custom-input" 
                        style="min-width: 250px;"
                    >
                        <option value="all">Tampilkan Semua Auditee</option>
                    </select>
                </div>
            </div>
            <div class="results-table-wrapper">
                <table class="monitoring-data-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th class="col-company">Perusahaan</th>
                            <th class="col-auditee">Auditee</th>
                            <th class="col-pic">PIC Auditee</th>
                            <th class="col-pic">PIC SKAI</th>
                            <th class="col-pic">PIC Reminder</th>
                            <th class="col-pic" style="text-align: center;">Dibuat oleh</th>
                            <th>Perihal</th>
                            <th>Deadline</th>
                            <th>Status</th>
                            <th>Sisa Hari</th>
                            <th style="min-width: 120px; text-align: center;">Reminder ke-</th>
                            <th class="col-temuan">Temuan</th>
                            <th class="col-checkbox">Reminded?</th>
                            <th class="col-checkbox">Responded?</th>
                            <th>Opsi</th>
                        </tr>
                    </thead>
                    <tbody id="past-tbody"></tbody>
                </table>
            </div>
        </section>

        <section class="data-table-container">
            <div class="list-header">
                <h3 style="margin: 0; color: var(--text-color);">Data Reminder (Active)</h3>
                <div 
                    class="controls-container" 
                    style="margin-bottom: 0;"
                >
                    <input 
                        type="text" 
                        id="active-search-input" 
                        class="custom-input" 
                        style="min-width: 250px;" 
                        placeholder="Cari Perihal / Auditee..."
                    >
                </div>
            </div>
            <div class="results-table-wrapper">
                <table class="monitoring-data-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th class="col-company">Perusahaan</th>
                            <th class="col-auditee">Auditee</th>
                            <th class="col-pic">PIC Auditee</th>
                            <th class="col-pic">PIC SKAI</th>
                            <th class="col-pic">PIC Reminder</th>
                            <th class="col-pic" style="text-align: center;">Dibuat oleh</th>
                            <th>Perihal</th>
                            <th>Deadline</th>
                            <th>Status</th>
                            <th>Sisa Hari</th>
                            <th class="col-temuan">Temuan</th>
                            <th class="col-checkbox">Reminded?</th>
                            <th class="col-checkbox">Responded?</th>
                            <th>Opsi</th>
                        </tr>
                    </thead>
                    <tbody id="active-tbody"></tbody>
                </table>
            </div>
        </section>

        {% else %}
        
        <div class="empty-dashboard">
            <div style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;">üì≠</div>
            <h3>Tidak Ada Data Reminder</h3>
            <p>Untuk saat ini, Anda belum memiliki deadline reminder dari Tim SKAI IFG.</p>
        </div>

        {% endif %}
    </main>
    
    <footer>
        <p>2025 Dashboard CoE | Departemen Center of Excellence, Satuan Kerja Audit Internal | Indonesia Financial Group</p>
    </footer>

    <!-- MODALS (Tidak ada perubahan isi, hanya style z-index disesuaikan di CSS) -->
    <div 
        id="confirmation-warning-modal" 
        class="modal hidden" 
        style="z-index: 3200;"
    >
        <div 
            class="modal-content" 
            style="max-width: 500px; text-align: center; padding: 2.5rem; border-radius: 12px;"
        >
            <div style="font-size: 3.5rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <h3 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 1.4rem;">Konfirmasi Respon</h3>
            <p style="font-size: 1rem; color: #555; line-height: 1.6; margin-bottom: 2rem; text-align: center;">
                Dengan Anda klik Save, Tim SKAI IFG akan menerima informasi bahwa Anda sudah merespon terhadap Tindak Lanjut.
            </p>
            <div 
                class="modal-actions" 
                style="justify-content: center; gap: 15px;"
            >
                <button 
                    id="btn-cancel-warning" 
                    class="btn-share-cancel" 
                    style="flex:1; max-width:150px;"
                >
                    Batal
                </button>
                <button 
                    id="btn-confirm-warning" 
                    class="btn-save" 
                    style="flex:1; max-width:150px;"
                >
                    Ya, Simpan
                </button>
            </div>
        </div>
    </div>

    <div 
        id="link-temuan-modal" 
        class="modal hidden" 
        style="z-index: 2600;"
    >
        <div 
            class="modal-content box-layout-modal" 
            style="width: 600px !important;"
        >
            <span 
                class="modal-close-btn" 
                onclick="closeModal('link-temuan-modal')"
            >
                &times;
            </span>
            <h3 style="color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 10px;">Input Detail Temuan</h3>
            <input 
                type="hidden" 
                id="link-reminder-id"
            >
            
            <div class="form-grid-wrapper">
                <div class="form-group">
                    <label>Pilih Jenis Temuan (Sesi):</label>
                    <select 
                        id="link-session-select" 
                        class="custom-input"
                    >
                        <option value="" disabled selected>-- Pilih Sesi Temuan --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filter by:</label>
                    <select 
                        id="link-filter-column" 
                        class="custom-input" 
                        disabled
                    >
                        <option value="" disabled selected>-- Pilih Sesi Terlebih Dahulu --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Then by:</label>
                    <select 
                        id="link-filter-value" 
                        class="custom-input" 
                        disabled
                    >
                        <option value="" disabled selected>-- Pilih Filter Terlebih Dahulu --</option>
                    </select>
                </div>
            </div>
            
            <div style="font-size: 0.85rem; color: var(--text-muted); background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <strong style="color: var(--primary);">Info:</strong> Dengan menekan tombol Simpan, semua data temuan yang sesuai dengan kriteria filter di atas akan otomatis ditautkan ke reminder ini.
            </div>
            
            <div class="modal-actions">
                <button 
                    type="button" 
                    class="btn-share-cancel" 
                    onclick="closeModal('link-temuan-modal')"
                >
                    Batal
                </button>
                <button 
                    type="button" 
                    class="btn-save" 
                    id="btn-save-link" 
                    style="padding: 10px 20px;"
                >
                    Simpan & Tautkan
                </button>
            </div>
        </div>
    </div>

    <div 
        id="add-reminder-modal" 
        class="modal hidden"
    >
        <div class="modal-content box-layout-modal">
            <span 
                class="modal-close-btn" 
                onclick="closeModal('add-reminder-modal')"
            >
                &times;
            </span>
            <h2 style="color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Buat Reminder Baru</h2>
            <form id="add-reminder-form">
                <div class="form-grid-wrapper">
                    <div class="form-group">
                        <label>Auditee:</label>
                        <button 
                            type="button" 
                            id="btn-open-auditee-modal" 
                            class="btn-select-pic"
                        >
                            <span id="display-auditee-text">-- Pilih Auditee --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            name="auditee" 
                            id="final-auditee-input" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>Perihal:</label>
                        <input 
                            type="text" 
                            name="subject" 
                            required 
                            placeholder="Contoh: Submit Laporan"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>PIC SKAI:</label>
                        <button 
                            type="button" 
                            id="btn-select-pic-add" 
                            class="btn-select-pic"
                        >
                            <span id="selected-pic-text-add">-- Pilih PIC --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            name="pic_skai" 
                            id="input-pic-skai-add"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>PIC Auditee:</label>
                        <textarea 
                            name="pic_auditee" 
                            id="input-pic-auditee-add" 
                            rows="4" 
                            placeholder="1. Nama PIC 1&#10;2. Nama PIC 2"
                        ></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>PIC Reminder:</label>
                        <button 
                            type="button" 
                            id="btn-select-pic-reminder-add" 
                            class="btn-select-pic"
                        >
                            <span id="selected-pic-reminder-text-add">-- Pilih PIC Reminder --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            name="pic_reminder" 
                            id="input-pic-reminder-add"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>Deadline:</label>
                        <input 
                            type="date" 
                            name="deadline" 
                            required
                        >
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button 
                        type="button" 
                        class="btn-share-cancel" 
                        onclick="closeModal('add-reminder-modal')"
                    >
                        Batal
                    </button>
                    <button 
                        type="submit" 
                        class="btn-save" 
                        style="padding: 10px 20px;"
                    >
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div 
        id="edit-reminder-modal" 
        class="modal hidden"
    >
        <div class="modal-content box-layout-modal">
            <span 
                class="modal-close-btn" 
                onclick="closeModal('edit-reminder-modal')"
            >
                &times;
            </span>
            <h2 style="color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Edit Reminder</h2>
            <form id="edit-reminder-form">
                <input 
                    type="hidden" 
                    id="edit-id" 
                    name="id"
                >
                <div class="form-grid-wrapper">
                    <div class="form-group">
                        <label>Auditee:</label>
                        <button 
                            type="button" 
                            id="btn-open-auditee-modal-edit" 
                            class="btn-select-pic"
                        >
                            <span id="edit-display-auditee-text">-- Pilih Auditee --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            id="edit-auditee" 
                            name="auditee" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>Perihal:</label>
                        <input 
                            type="text" 
                            id="edit-subject" 
                            name="subject" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>PIC SKAI:</label>
                        <button 
                            type="button" 
                            id="btn-select-pic-edit" 
                            class="btn-select-pic"
                        >
                            <span id="selected-pic-text-edit">-- Pilih PIC --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            name="pic_skai" 
                            id="input-pic-skai-edit"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>PIC Auditee:</label>
                        <button 
                            type="button" 
                            id="btn-select-pic-auditee-edit" 
                            class="btn-select-pic"
                        >
                            <span id="selected-pic-auditee-text-edit">-- Pilih PIC Auditee --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            name="pic_auditee" 
                            id="input-pic-auditee-edit"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>PIC Reminder:</label>
                        <button 
                            type="button" 
                            id="btn-select-pic-reminder-edit" 
                            class="btn-select-pic"
                        >
                            <span id="selected-pic-reminder-text-edit">-- Pilih PIC Reminder --</span><span>&#9662;</span>
                        </button>
                        <input 
                            type="hidden" 
                            name="pic_reminder" 
                            id="input-pic-reminder-edit"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label>Deadline:</label>
                        <input 
                            type="date" 
                            id="edit-deadline" 
                            name="deadline" 
                            required
                        >
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button 
                        type="button" 
                        class="btn-share-cancel" 
                        onclick="closeModal('edit-reminder-modal')"
                    >
                        Batal
                    </button>
                    <button 
                        type="submit" 
                        class="btn-save" 
                        style="padding: 10px 20px;"
                    >
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div 
        id="auditee-selection-modal" 
        class="modal hidden" 
        style="z-index: 2800;"
    >
        <div 
            class="modal-content box-layout-modal" 
            style="width: 500px !important;"
        >
            <span 
                class="modal-close-btn" 
                onclick="closeModal('auditee-selection-modal')"
            >
                &times;
            </span>
            <h3 style="text-align:center; color: var(--primary-color);">Pilih Auditee Anda</h3>
            <div class="form-group">
                <label>Perusahaan:</label>
                <select 
                    id="select-company" 
                    class="custom-input"
                >
                    <option value="" disabled selected>-- Pilih Perusahaan --</option>
                </select>
            </div>
            <div 
                id="auditee-wrapper" 
                class="form-group hidden"
            >
                <label>Auditee (Divisi):</label>
                <select 
                    id="select-auditee-unit" 
                    class="custom-input"
                >
                    <option value="" disabled selected>-- Pilih Divisi --</option>
                </select>
            </div>
            <div 
                class="modal-actions" 
                style="justify-content: center;"
            >
                <button 
                    type="button" 
                    class="btn-share-cancel" 
                    onclick="closeModal('auditee-selection-modal')"
                >
                    Batal
                </button>
                <button 
                    type="button" 
                    class="btn-save" 
                    id="save-auditee-selection" 
                    style="padding: 10px 20px;"
                >
                    Pilih
                </button>
            </div>
        </div>
    </div>
    
    <div 
        id="user-selection-modal" 
        class="modal hidden" 
        style="z-index: 2500;"
    >
        <div class="modal-content">
            <span 
                class="share-close-x" 
                onclick="closeModal('user-selection-modal')"
            >
                &times;
            </span>
            <div class="share-header"><h3>Pilih User</h3></div>
            <div id="user-search-container">
                <input 
                    type="text" 
                    id="user-search-input" 
                    placeholder="Cari nama user..." 
                    autocomplete="off"
                >
            </div>
            <div class="share-table-wrapper">
                <table class="share-table">
                    <thead>
                        <tr>
                            <th>Pilih</th>
                            <th>Username</th>
                            <th>Label</th>
                        </tr>
                    </thead>
                    <tbody id="user-selection-tbody"></tbody>
                </table>
            </div>
            <div class="share-footer">
                <button 
                    class="btn-share-cancel" 
                    onclick="closeModal('user-selection-modal')"
                >
                    Batal
                </button>
                <button 
                    class="btn-save" 
                    id="btn-save-user"
                >
                    Simpan Pilihan
                </button>
            </div>
        </div>
    </div>

    <div 
        id="tembusan-selection-modal" 
        class="modal hidden" 
        style="z-index: 2550;"
    >
        <div class="modal-content">
            <span 
                class="share-close-x" 
                onclick="closeModal('tembusan-selection-modal')"
            >
                &times;
            </span>
            <div class="share-header"><h3>Pilih Tembusan</h3></div>
            <div id="user-search-container">
                <input 
                    type="text" 
                    id="tembusan-search-input" 
                    placeholder="Cari label..." 
                    autocomplete="off"
                >
            </div>
            <div class="share-table-wrapper">
                <table class="share-table">
                    <thead>
                        <tr>
                            <th>Pilih</th>
                            <th>Label</th>
                        </tr>
                    </thead>
                    <tbody id="tembusan-selection-tbody"></tbody>
                </table>
            </div>
            <div class="share-footer">
                <button 
                    class="btn-share-cancel" 
                    onclick="closeModal('tembusan-selection-modal')"
                >
                    Batal
                </button>
                <button 
                    class="btn-save" 
                    id="btn-save-tembusan"
                >
                    Simpan Pilihan
                </button>
            </div>
        </div>
    </div>
    
    <div 
        id="deadline-notification-modal" 
        class="modal hidden" 
        style="z-index: 3000;"
    >
        <div 
            class="modal-content" 
            style="max-width: 500px; padding: 2rem; text-align: center;"
        >
            <div class="notif-icon">üîî</div>
            <h3 style="color: var(--secondary-color);">Pengingat Deadline</h3>
            <div 
                id="deadline-notif-content" 
                class="notif-text"
            ></div>
            <button 
                class="btn-share-cancel" 
                onclick="closeModal('deadline-notification-modal')"
            >
                Tutup
            </button>
        </div>
    </div>

    <div 
        id="custom-message-modal" 
        class="modal hidden"
    >
        <div 
            class="modal-content" 
            style="max-width:400px; text-align:center; padding:2rem;"
        >
            <h3 id="custom-message-title">Pesan</h3>
            <p id="custom-message-text"></p>
            <button 
                onclick="closeModal('custom-message-modal')" 
                class="action-btn btn-save" 
                style="width:100%;"
            >
                OK
            </button>
        </div>
    </div>

    <div 
        id="custom-confirm-modal" 
        class="modal hidden"
    >
        <div 
            class="modal-content" 
            style="max-width:400px; text-align:center; padding:2rem;"
        >
            <h3>Konfirmasi</h3>
            <p id="custom-confirm-text"></p>
            <div 
                style="display:flex; gap:10px; justify-content:center; margin-top:1rem;"
            >
                <button 
                    id="custom-confirm-ok-btn" 
                    class="action-btn btn-save" 
                    style="flex: 1;"
                >
                    Ya
                </button>
                <button 
                    id="custom-confirm-cancel-btn" 
                    class="btn-share-cancel" 
                    style="flex: 1;"
                >
                    Batal
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='ams_reminder.js') }}?v=14"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const COMPANY_LIST = [
                "Askrindo", "Bahana Artha Ventura", "Bahana Kapital Investa", "Bahana Sekuritas",
                "Bahana TCW Investment Management", "IFG", "IFG Life", "Jamkrindo", "Jasa Raharja",
                "Jasindo", "Kementrian Badan Usaha Milik Negara (KBUMN)", "Mandiri Inhealth",
                "Nasional Re (Nasre)", "PT Grahaniaga Tatautama"
            ].sort();

            const IFG_DIVISIONS = [
                "Divisi Aktuaria", "Divisi Akuntansi & Pelaporan", "Divisi Bisnis Asuransi Jiwa",
                "Divisi Bisnis Asuransi Umum & Penjaminan", "Divisi Bisnis Capital Market & Investasi",
                "Divisi Hukum", "Divisi Keuangan Perusahaan", "Divisi M&A dan Partnership",
                "Divisi Manajemen Portofolio Investeasi & Anak Perusahaan",
                "Divisi Manajemen Risiko, Kepatuhan dan Kebijakan", "Divisi Optimasi Operasional Asuransi",
                "Divisi Pengadaan & Pengelolaan Aset", "Divisi Perusahaan",
                "Divisi Satuan Kerja Audit Internal", "Divisi Sekretaris Perusahaan",
                "Divisi Special Liability Management", "Divisi Strategi Digital & Pengembangan Bisnis",
                "Divisi Sumber Daya Manusia", "Divisi Teknologi Informasi", "SEVP IFG Progress",
                "SEVP Manajemen Bisnis", "SEVP Teknologi Informasi", "SEVP Transformasi"
            ].sort();

            let globalPastData = [];
            let globalActiveData = [];
            let allUsersCache = [];
            let currentSessionData = [];
            let currentLinkReminderId = null;
            let pendingWarningId = null;

            let targetInputId = null;  
            let targetDisplayId = null;
            let targetAuditeeInputId = null;  
            let targetAuditeeDisplayId = null;
            
            const currentUsername = document.getElementById('current-username').value;

            const els = {
                pastTbody: document.getElementById('past-tbody'),
                activeTbody: document.getElementById('active-tbody'),
                warningSection: document.getElementById('warning-section'),
                warningTbody: document.getElementById('warning-tbody'),
                loading: document.getElementById('loading-indicator'),
                pastFilter: document.getElementById('past-filter-dropdown'),
                activeSearch: document.getElementById('active-search-input'),
                addModal: document.getElementById('add-reminder-modal'),
                editModal: document.getElementById('edit-reminder-modal'),
                linkModal: document.getElementById('link-temuan-modal'),
                auditeeModal: document.getElementById('auditee-selection-modal'),
                userModal: document.getElementById('user-selection-modal'),
                tembusanModal: document.getElementById('tembusan-selection-modal'),
                warningModal: document.getElementById('confirmation-warning-modal'),
                addForm: document.getElementById('add-reminder-form'),
                editForm: document.getElementById('edit-reminder-form'),
                selectCompany: document.getElementById('select-company'),
                selectAuditeeUnit: document.getElementById('select-auditee-unit'),
                auditeeWrapper: document.getElementById('auditee-wrapper'),
                saveAuditeeBtn: document.getElementById('save-auditee-selection'),
                userSearchInput: document.getElementById('user-search-input'),
                userSelectionTbody: document.getElementById('user-selection-tbody'),
                btnSaveUser: document.getElementById('btn-save-user'),
                linkSession: document.getElementById('link-session-select'),
                linkCol: document.getElementById('link-filter-column'),
                linkVal: document.getElementById('link-filter-value'),
                btnSaveLink: document.getElementById('btn-save-link'),
                btnConfirmWarning: document.getElementById('btn-confirm-warning'),
                btnCancelWarning: document.getElementById('btn-cancel-warning'),
                btnAddReminder: document.getElementById('add-reminder-btn')
            };

            window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
            const openModal = (el) => { if (el) el.classList.remove('hidden'); };

            function showMessage(msg, type = 'info') {
                const m = document.getElementById('custom-message-modal');
                document.getElementById('custom-message-text').textContent = msg;
                const t = document.getElementById('custom-message-title');
                t.textContent = type === 'success' ? 'Sukses' : 'Informasi';
                t.style.color = type === 'error' ? 'var(--primary-color)' : 'green';
                openModal(m);
            }

            function showConfirm(msg, onConfirm) {
                const m = document.getElementById('custom-confirm-modal');
                document.getElementById('custom-confirm-text').textContent = msg;
                const okBtn = document.getElementById('custom-confirm-ok-btn');
                const cancelBtn = document.getElementById('custom-confirm-cancel-btn');
                const newOk = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOk, okBtn);
                newOk.onclick = () => { closeModal('custom-confirm-modal'); onConfirm(true); };
                cancelBtn.onclick = () => { closeModal('custom-confirm-modal'); onConfirm(false); };
                openModal(m);
            }

            function init() {
                COMPANY_LIST.forEach(c => els.selectCompany.add(new Option(c, c)));
                IFG_DIVISIONS.forEach(d => els.selectAuditeeUnit.add(new Option(d, d)));
                setupEventListeners();
                loadReminders();
                checkDeadlines();
            }

            function setupEventListeners() {
                els.btnAddReminder.onclick = () => {
                    els.addForm.reset();
                    els.selectAuditeeUnit.value = "";
                    els.auditeeWrapper.classList.add('hidden');
                    const resetText = (id, text) => {  
                        const el = document.getElementById(id);  
                        if(el) { el.textContent = text; el.style.color = "#333"; el.style.fontWeight = "normal"; } 
                    };
                    resetText('display-auditee-text', "-- Pilih Auditee --");
                    resetText('selected-pic-text-add', "-- Pilih PIC --");
                    resetText('selected-pic-reminder-text-add', "-- Pilih PIC Reminder --");
                    
                    document.getElementById('input-pic-auditee-add').value = "";
                    
                    ['input-pic-skai-add','input-pic-reminder-add'].forEach(id => document.getElementById(id).value = "");
                    openModal(els.addModal);
                };

                els.addForm.onsubmit = (e) => handleFormSubmit(e, '/api/add_reminder', 'add-reminder-modal', 'Berhasil disimpan');
                els.editForm.onsubmit = (e) => handleFormSubmit(e, `/api/edit_reminder/${document.getElementById('edit-id').value}`, 'edit-reminder-modal', 'Data diperbarui');

                document.getElementById('btn-open-auditee-modal').onclick = () => openAuditeeModal('final-auditee-input', 'display-auditee-text');
                document.getElementById('btn-open-auditee-modal-edit').onclick = () => openAuditeeModal('edit-auditee', 'edit-display-auditee-text');
                els.selectCompany.addEventListener('change', () => {
                    if (els.selectCompany.value === 'IFG') {
                        els.auditeeWrapper.classList.remove('hidden'); els.selectAuditeeUnit.required = true;
                    } else {
                        els.auditeeWrapper.classList.add('hidden'); els.selectAuditeeUnit.value = ""; els.selectAuditeeUnit.required = false;
                    }
                });
                els.saveAuditeeBtn.onclick = handleSaveAuditee;

                document.getElementById('btn-select-pic-add').onclick = () => openUserModal('input-pic-skai-add', 'selected-pic-text-add');
                document.getElementById('btn-select-pic-reminder-add').onclick = () => openUserModal('input-pic-reminder-add', 'selected-pic-reminder-text-add');

                document.getElementById('btn-select-pic-edit').onclick = () => openUserModal('input-pic-skai-edit', 'selected-pic-text-edit');
                document.getElementById('btn-select-pic-reminder-edit').onclick = () => openUserModal('input-pic-reminder-edit', 'selected-pic-reminder-text-edit');

                els.userSearchInput.addEventListener('keyup', (e) => filterTable(e.target.value, '#user-selection-tbody'));
                els.btnSaveUser.onclick = handleSaveUserSelection;

                els.linkSession.addEventListener('change', handleLinkSessionChange);
                els.linkCol.addEventListener('change', handleLinkColumnChange);
                els.btnSaveLink.onclick = handleSaveLink;

                els.pastFilter.addEventListener('change', (e) => {
                    const val = e.target.value;
                    const data = val === 'all' ? globalPastData : globalPastData.filter(i => i.auditee === val);
                    renderTable(data, els.pastTbody);
                });
                els.activeSearch.addEventListener('keyup', (e) => {
                    const val = e.target.value.toLowerCase();
                    const data = globalActiveData.filter(i => (i.auditee && i.auditee.toLowerCase().includes(val)) || (i.subject && i.subject.toLowerCase().includes(val)));
                    renderTable(data, els.activeTbody);
                });

                els.btnConfirmWarning.onclick = () => {
                    if (pendingWarningId) { executeSaveWarning(pendingWarningId, true); closeModal('confirmation-warning-modal'); pendingWarningId = null; }
                };
                els.btnCancelWarning.onclick = () => {
                    if (pendingWarningId) { const cb = document.getElementById(`warn-check-${pendingWarningId}`); if (cb) cb.checked = false; }
                    closeModal('confirmation-warning-modal'); pendingWarningId = null;
                };
            }

            async function loadReminders() {
                els.loading.classList.remove('hidden');
                try {
                    els.activeSearch.value = "";
                    const res = await fetch('/api/get_reminders');
                    const data = await res.json();
                    const processed = data.map(item => {
                        if (item.is_overdue === undefined) {
                            const t = new Date(); t.setHours(0, 0, 0, 0);
                            const d = new Date(item.deadline_raw); d.setHours(0, 0, 0, 0);
                            item.is_overdue = d < t;
                        }
                        return item;
                    });
                    globalPastData = processed.filter(i => i.is_overdue);
                    globalActiveData = processed.filter(i => !i.is_overdue);
                    
                    renderTable(globalPastData, els.pastTbody);
                    renderTable(globalActiveData, els.activeTbody);
                    renderWarningTable(processed);
                    populateFilterDropdown(globalPastData);
                } catch (e) { console.error("Load Error:", e); } 
                finally { els.loading.classList.add('hidden'); }
            }

            function renderTable(data, tbody) {
                tbody.innerHTML = '';
                if (!data.length) { tbody.innerHTML = '<tr><td colspan="15" style="text-align:center; padding:2rem; color:#999;">Belum ada data.</td></tr>'; return; }
                data.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    const statusObj = getStatusStyle(item.status, item.is_overdue);
                    const { col1, col2 } = getCompanyColumns(item.auditee);
                    
                    const picSkai = formatUserListHTML(item.pic_skai);
                    const picRem = formatUserListHTML(item.pic_reminder);
                    const picAud = formatUserListHTML(item.pic_auditee);
                    
                    let isPicReminder = false;
                    if (item.pic_reminder) {
                        const arr = Array.isArray(item.pic_reminder) 
                            ? item.pic_reminder 
                            : item.pic_reminder.split(',');
                        
                        isPicReminder = arr
                            .map(s => s.trim())
                            .includes(currentUsername);
                    }

                    const canRemind = isPicReminder || item.is_owner;
                    const canInput = isPicReminder || item.is_owner;
                    const canEditResponded = item.is_owner || item.is_current_user_pic;
                    const { displaySisa, styleSisa } = calculateSLA(item.deadline_raw);
                    const temuanBtn = getTemuanButton(item, canInput);

                    let reminderLevelHtml = '';
                    if (tbody.id === 'past-tbody') {
                        const d1 = new Date(item.deadline_raw);
                        d1.setHours(0,0,0,0);
                        const d2 = new Date();
                        d2.setHours(0,0,0,0);
                        const diffTime = d2 - d1;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                        let reminders = [];
                        
                        if (!item.is_responded) {
                            const styleBase = "padding: 6px; width: 100%; box-sizing: border-box; font-size: 0.85em; font-weight: 700;";
                            const styleYellow = "background-color: #FFFde7; color: #e65100;"; // Updated yellow style
                            const styleRed = "background-color: #FFEBEE; color: #C62828;";
                            
                            if (diffDays > 0) {
                                const isLate = diffDays > 5;
                                const style = isLate ? styleRed : styleYellow;
                                const border = (diffDays > 5) ? "border-bottom: 1px solid #ddd;" : "";
                                reminders.push(`<div style="${styleBase} ${style} ${border}">1 (Pertama)</div>`);
                            }
                            if (diffDays > 5) {
                                const isLate = diffDays > 10;
                                const style = isLate ? styleRed : styleYellow;
                                const border = (diffDays > 10) ? "border-bottom: 1px solid #ddd;" : "";
                                reminders.push(`<div style="${styleBase} ${style} ${border}">2 (Kedua)</div>`);
                            }
                            if (diffDays > 10) {
                                const isLate = diffDays > 15;
                                const style = isLate ? styleRed : styleYellow;
                                reminders.push(`<div style="${styleBase} ${style}">3 (Ketiga)</div>`);
                            }
                        }

                        reminderLevelHtml = `<td style="padding: 0; vertical-align: top; min-width: 130px;">
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                ${reminders.join('')}
                            </div>
                        </td>`;
                    }

                    tr.innerHTML = `
                        <td>${index + 1}</td> ${col1} ${col2}
                        <td class="col-pic" style="text-align:left; vertical-align:top;">${picAud}</td>
                        <td class="col-pic" style="text-align:left; vertical-align:top;">${picSkai}</td>
                        <td class="col-pic" style="text-align:left; vertical-align:top;">${picRem}</td>
                        
                        <td class="col-pic" style="text-align:center; vertical-align:middle;">
                            <span style="font-weight: 600;">${item.creator_fullname || item.creator_name}</span> 
                            <br>
                            <span style="font-size: 0.8em; color: var(--text-muted);">${item.created_at}</span>
                        </td>
                        
                        <td>${item.subject || '-'}</td>  
                        <td>${item.deadline || '-'}</td>
                        <td><span class="status-badge" style="background:${statusObj.bg}; color:${statusObj.text};">${item.status}</span></td>
                        <td style="${styleSisa}">${displaySisa}</td>
                        ${reminderLevelHtml}
                        <td class="col-temuan" style="text-align:center;">${temuanBtn}</td>
                        
                        <td class="col-checkbox">
                            <input 
                                type="checkbox" 
                                id="remind-check-${item.id}" 
                                ${!canRemind ? 'disabled' : ''} 
                                style="transform: scale(1.5);" 
                                ${item.is_reminded ? 'checked' : ''}
                            >
                        </td>
                        
                        <td class="col-checkbox">
                            <input 
                                type="checkbox" 
                                id="respon-check-${item.id}" 
                                style="transform: scale(1.5);" 
                                ${item.is_responded ? 'checked' : ''} 
                                ${!canEditResponded ? 'disabled' : ''}
                            >
                        </td>
                        <td>
                            <div style="display:flex; gap:5px; justify-content:center;">
                                <button 
                                    class="action-btn btn-save" 
                                    onclick="saveStatus(${item.id})"
                                >
                                    Save
                                </button>
                                <button 
                                    class="action-btn btn-edit" 
                                    onclick='openEdit(${JSON.stringify(item).replace(/'/g, "&#39;")})'  
                                >
                                    Edit
                                </button>
                                <button 
                                    class="action-btn btn-delete" 
                                    onclick="deleteItem(${item.id})"
                                >
                                    Hapus
                                </button>
                            </div>
                        </td>`;
                    tbody.appendChild(tr);
                });
            }

            function renderWarningTable(data) {
                const warningData = data.filter(item => {
                    const picAuditee = item.pic_auditee || "";
                    return picAuditee.includes(currentUsername) && !item.is_responded;
                });
                if (warningData.length === 0) { els.warningSection.style.display = 'none'; return; }
                els.warningSection.style.display = 'block'; els.warningTbody.innerHTML = '';
                warningData.forEach((item, index) => {
                    const picSkai = formatUserListHTML(item.pic_skai);
                    const statusObj = getStatusStyle(item.status, item.is_overdue);
                    const { displaySisa, isOverdue } = calculateSLA(item.deadline_raw);
                    let slaBadge = isOverdue 
                        ? `<span class="sla-badge sla-overdue">${displaySisa}</span>` 
                        : displaySisa === "Hari Ini" 
                            ? '<span class="sla-badge sla-warning-1">Deadline Hari Ini</span>' 
                            : '<span class="sla-badge sla-safe">Aman</span>';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${item.subject || '-'}</td>
                        <td class="col-pic" style="text-align:left;">${picSkai}</td>
                        <td>${item.deadline}</td>
                        <td>
                            <span class="status-badge" style="background:${statusObj.bg}; color:${statusObj.text};">
                                ${item.status}
                            </span>
                        </td>
                        <td style="text-align:center;">${slaBadge}</td>
                        <td class="col-checkbox">
                            <input 
                                type="checkbox" 
                                id="warn-check-${item.id}" 
                                style="transform: scale(1.5); cursor:pointer;" 
                                ${item.is_responded ? 'checked' : ''}
                            >
                        </td>
                        <td style="text-align:center;">
                            <button class="action-btn btn-save" onclick="saveWarningResponse(${item.id})">
                                Save
                            </button>
                        </td>
                    `;
                    els.warningTbody.appendChild(tr);
                });
            }

            window.openEdit = (item) => {
                document.getElementById('edit-id').value = item.id;
                document.getElementById('edit-auditee').value = item.auditee;
                const dispAuditee = document.getElementById('edit-display-auditee-text');
                dispAuditee.textContent = item.auditee; 
                dispAuditee.style.fontWeight = "bold"; 
                dispAuditee.style.color = "var(--primary-color)";
                document.getElementById('edit-subject').value = item.subject;
                document.getElementById('edit-deadline').value = item.deadline_raw;

                const setPicData = (raw, inputId, displayId) => {
                    const val = raw || ''; 
                    const arr = Array.isArray(val) ? val : val.split(',').filter(x => x);
                    document.getElementById(inputId).value = arr.join(',');
                    const displayText = arr.length ? `${arr.length} PIC` : '-- Pilih PIC --';
                    document.getElementById(displayId).textContent = displayText;
                    return arr;
                };
                setPicData(item.pic_skai, 'input-pic-skai-edit', 'selected-pic-text-edit');
                const picRemArr = setPicData(item.pic_reminder, 'input-pic-reminder-edit', 'selected-pic-reminder-text-edit');
                
                let auditeeVal = item.pic_auditee || '';
                if(Array.isArray(auditeeVal)) {
                    auditeeVal = auditeeVal.join('\n');
                } else if(auditeeVal.includes(',')) {
                    auditeeVal = auditeeVal.split(',').join('\n');
                }
                document.getElementById('input-pic-auditee-edit').value = auditeeVal;

                const isPicReminder = picRemArr
                    .map(s => s.trim())
                    .includes(currentUsername);
                const btnEditSkai = document.getElementById('btn-select-pic-edit');
                if (isPicReminder && !item.is_owner) { 
                    btnEditSkai.disabled = true; 
                    btnEditSkai.title = "Hanya Owner/PIC SKAI yang dapat mengubah ini"; 
                } else { 
                    btnEditSkai.disabled = false; 
                    btnEditSkai.title = ""; 
                }
                openModal(els.editModal);
            };

            async function handleFormSubmit(e, url, modalId, successMsg) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                const splitAndClean = (id) => document.getElementById(id).value.split(',').filter(x => x);
                
                if (modalId === 'add-reminder-modal') {
                    data.pic_skai = splitAndClean('input-pic-skai-add'); 
                    data.pic_reminder = splitAndClean('input-pic-reminder-add'); 
                    data.pic_auditee = document.getElementById('input-pic-auditee-add').value; 
                } else {
                    data.pic_skai = splitAndClean('input-pic-skai-edit'); 
                    data.pic_reminder = splitAndClean('input-pic-reminder-edit'); 
                    data.pic_auditee = document.getElementById('input-pic-auditee-edit').value; 
                }
                
                data.tembusan = ""; 
                
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    if (res.ok) { closeModal(modalId); if (modalId === 'add-reminder-modal') e.target.reset(); loadReminders(); showMessage(successMsg, "success"); } 
                    else { const err = await res.json(); showMessage("Gagal menyimpan: " + (err.error || "Error Server"), "error"); }
                } catch (err) { showMessage("Terjadi kesalahan koneksi.", "error"); }
            }

            window.saveStatus = async (id) => {
                const payload = { is_responded: document.getElementById(`respon-check-${id}`).checked, is_reminded: !document.getElementById(`remind-check-${id}`).disabled ? document.getElementById(`remind-check-${id}`).checked : undefined };
                try { const res = await fetch(`/api/update_reminder_response/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (res.ok) showMessage("Status tersimpan", "success"); else showMessage("Gagal menyimpan status", "error"); } catch (e) { showMessage("Error koneksi", "error"); }
            };

            window.deleteItem = (id) => {
                showConfirm("Apakah Anda yakin ingin menghapus reminder ini?", async (yes) => {
                    if (yes) {
                        try {
                            const res = await fetch(`/api/delete_reminder/${id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (res.ok) {
                                loadReminders();
                                showMessage("Data dihapus.", "success");
                            } else {
                                let pesanError = "Gagal menghapus data.";
                                try {
                                    const errData = await res.json();
                                    if (errData.error) {
                                        pesanError = errData.error;
                                    } else if (errData.message) {
                                        pesanError = errData.message;
                                    }
                                } catch (parseErr) {
                                    console.error("Gagal parsing error response", parseErr);
                                }
                                
                                showMessage(pesanError, "error");
                            }
                        } catch (e) {
                            console.error(e);
                            showMessage("Error koneksi: " + e.message, "error");
                        }
                    }
                });
            };

            window.saveWarningResponse = async (id) => {
                const checkbox = document.getElementById(`warn-check-${id}`);
                if (!checkbox.checked) { await executeSaveWarning(id, false); return; }
                pendingWarningId = id;
                openModal(els.warningModal);
            };
            async function executeSaveWarning(id, isChecked) { try { const res = await fetch(`/api/update_reminder_response/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_responded: isChecked }) }); if (res.ok) { showMessage("Respon berhasil disimpan!", "success"); loadReminders(); } else { showMessage("Gagal menyimpan.", "error"); const cb = document.getElementById(`warn-check-${id}`); if (cb) cb.checked = !isChecked; } } catch (e) { showMessage("Terjadi kesalahan koneksi.", "error"); } }

            function openAuditeeModal(inputId, displayId) { targetAuditeeInputId = inputId; targetAuditeeDisplayId = displayId; els.selectCompany.value = ""; els.selectAuditeeUnit.value = ""; els.auditeeWrapper.classList.add('hidden'); openModal(els.auditeeModal); }
            function handleSaveAuditee() { const comp = els.selectCompany.value; if (!comp) return alert("Pilih Perusahaan"); let res = comp; if (comp === 'IFG') { if (!els.selectAuditeeUnit.value) return alert("Pilih Divisi"); res = `IFG - ${els.selectAuditeeUnit.value}`; } if (targetAuditeeInputId && targetAuditeeDisplayId) { document.getElementById(targetAuditeeInputId).value = res; const disp = document.getElementById(targetAuditeeDisplayId); disp.textContent = res; disp.style.fontWeight = "bold"; disp.style.color = "var(--primary-color)"; } closeModal('auditee-selection-modal'); }
            
            window.openUserModal = async (inputId, displayId) => { 
                targetInputId = inputId; 
                targetDisplayId = displayId; 
                els.userSearchInput.value = ""; 
                openModal(els.userModal); 
                
                if (!allUsersCache.length) { 
                    const r = await fetch('/api/get_all_users'); 
                    allUsersCache = await r.json(); 
                } 
                
                allUsersCache.sort((a, b) => {
                    const labelCompare = (a.label || "").localeCompare(b.label || "");
                    if (labelCompare !== 0) return labelCompare;
                    return (a.fullname || "").localeCompare(b.fullname || "");
                });

                const curVal = document.getElementById(inputId).value; 
                const cur = curVal ? curVal.split(',').map(s => s.trim()) : []; 
                const tbody = document.getElementById('user-selection-tbody'); 
                tbody.innerHTML = ''; 
                
                allUsersCache.forEach(u => { 
                    const tr = document.createElement('tr'); 
                    tr.innerHTML = `<td><input type="checkbox" class="user-select-cb" value="${u.fullname}" ${cur.includes(u.fullname) ? 'checked' : ''}></td><td>${u.fullname}</td><td><span class="badge" style="background:#eee;">${u.label}</span></td>`; 
                    tr.onclick = (e) => { 
                        if (e.target.type !== 'checkbox') tr.querySelector('input').click(); 
                    }; 
                    tbody.appendChild(tr); 
                }); 
            };
            
            function handleSaveUserSelection() { const sel = Array.from(document.querySelectorAll('.user-select-cb:checked')).map(c => c.value); document.getElementById(targetInputId).value = sel.join(','); document.getElementById(targetDisplayId).textContent = sel.length ? `${sel.length} PIC` : '-- Pilih PIC --'; closeModal('user-selection-modal'); }
            function filterTable(term, tbodySelector) { term = term.toLowerCase(); document.querySelectorAll(`${tbodySelector} tr`).forEach(row => { const text = row.textContent.toLowerCase(); row.style.display = text.includes(term) ? '' : 'none'; }); }

            window.openLinkModal = async (id) => { currentLinkReminderId = id; openModal(els.linkModal); els.linkSession.innerHTML = '<option>Memuat...</option>'; els.linkCol.disabled = true; els.linkVal.disabled = true; try { const r = await fetch('/api/get_temuan_sessions'); const s = await r.json(); els.linkSession.innerHTML = '<option value="" disabled selected>-- Pilih Sesi --</option>'; s.forEach(x => els.linkSession.add(new Option(`${x.jenis_audit} - ${x.nama_sesi}`, x.id))); } catch (e) { els.linkSession.innerHTML = '<option>Gagal memuat</option>'; } };
            async function handleLinkSessionChange(e) { els.linkCol.innerHTML = '<option>Memuat...</option>'; const r = await fetch(`/api/get_temuan_data/${e.target.value}`); currentSessionData = await r.json(); const FILTERABLE_COLUMNS = [{ key: 'no_aoi', label: 'No AOI' }, { key: 'jenis_aoi', label: 'Jenis AOI' }, { key: 'klasifikasi', label: 'Klasifikasi' }, { key: 'no_lha', label: 'No LHA' }, { key: 'nama_penugasan', label: 'Nama Penugasan' }, { key: 'aoi', label: 'Area of Improvement' }, { key: 'rekomendasi', label: 'Rekomendasi' }, { key: 'rencana_tl', label: 'Rencana TL' }, { key: 'auditee', label: 'Auditee' }, { key: 'pic_auditee', label: 'PIC Auditee' }, { key: 'target_penyelesaian', label: 'Target Penyelesaian' }, { key: 'signifikansi', label: 'Signifikansi' }, { key: 'control', label: 'Control' }]; els.linkCol.innerHTML = '<option value="" disabled selected>-- Pilih Kolom --</option>'; FILTERABLE_COLUMNS.forEach(c => els.linkCol.add(new Option(c.label, c.key))); els.linkCol.disabled = false; }
            function handleLinkColumnChange(e) { const k = e.target.value; const v = [...new Set(currentSessionData.map(r => r[k] ? r[k].toString().trim() : ""))].sort(); els.linkVal.innerHTML = '<option value="" disabled selected>-- Pilih Data --</option>'; v.forEach(x => { if (x) els.linkVal.add(new Option(x, x)); }); els.linkVal.disabled = false; }
            async function handleSaveLink() {
                const col = els.linkCol.value; const val = els.linkVal.value;
                const filteredRows = currentSessionData.filter(r => r[col] && r[col].toString().trim() === val);
                const ids = filteredRows.map(r => r.id);
                if (!ids.length) return alert("Data tidak ditemukan atau kriteria filter salah.");
                try {
                    const res = await fetch('/api/save_reminder_temuan_link', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reminder_id: currentLinkReminderId, temuan_ids: ids }) });
                    if (res.ok) {
                        window.location.href = `/assign_pic_page/${currentLinkReminderId}`;
                    } else { showMessage("Gagal menyimpan data.", "error"); }
                } catch (e) { showMessage("Terjadi kesalahan koneksi.", "error"); }
            }

            function getStatusStyle(status, isOverdue) { const s = (status || '').toUpperCase(); if (s.includes('HARI INI')) return { bg: 'var(--status-today-bg)', text: 'var(--status-today-text)' }; if (isOverdue) return { bg: 'var(--status-overdue-bg)', text: 'var(--status-overdue-text)' }; return { bg: 'var(--status-ok-bg)', text: 'var(--status-ok-text)' }; }
            function getCompanyColumns(rawAuditee) { rawAuditee = rawAuditee || ""; if (rawAuditee.startsWith("IFG - ")) { const unit = rawAuditee.replace("IFG - ", ""); return { col1: `<td><span class="badge badge-company">IFG</span></td>`, col2: `<td>${unit}</td>` }; } else { return { col1: `<td colspan="2" style="text-align:center;"><span class="badge badge-company">${rawAuditee}</span></td>`, col2: `` }; } }
            function getTemuanButton(item, canInput) {
                const count = item.visible_temuan_count || 0;
                
                if (count > 0) {
                    return `<a href="/view_linked_temuan/${item.id}" target="_blank" class="btn-view-temuan">View <span class="badge-count">${count}</span></a>`;
                }
                
                if (canInput) {
                    return `<button class="btn-input-temuan" onclick="openLinkModal(${item.id})">+ Input Temuan</button>`;
                }
                
                return `<span style="color:#999; font-size:0.8em;">-</span>`;
            }
            function calculateSLA(deadlineRaw) { const deadline = new Date(deadlineRaw); deadline.setHours(0, 0, 0, 0); const today = new Date(); today.setHours(0, 0, 0, 0); const diffTime = today - deadline; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); let displaySisa = "", styleSisa = "", isOverdue = false; if (diffDays > 0) { displaySisa = `+${Math.abs(diffDays)} hari`; styleSisa = "color: #D32F2F; font-weight: bold;"; isOverdue = true; } else if (diffDays === 0) { displaySisa = "Hari Ini"; styleSisa = "color: #F57F17; font-weight: bold;"; } else { displaySisa = `${Math.abs(diffDays)} hari`; styleSisa = "color: #2E7D32;"; } return { displaySisa, styleSisa, isOverdue }; }
            
            function formatUserListHTML(data) { 
                if (!data) return '-';
                
                if (typeof data === 'string' && data.includes('\n')) {
                    const arr = data.split('\n').filter(s => s.trim() !== "");
                    if (arr.length === 0) return '-';
                    return `<ul style="padding-left:15px; margin:0;">${arr.map(p => `<li>${p.trim()}</li>`).join('')}</ul>`;
                }
                
                const arr = Array.isArray(data) ? data : data.split(',');
                if (arr.length === 0) return '-';
                return `<ul style="padding-left:15px; margin:0;">${arr.map(p => `<li>${p.trim()}</li>`).join('')}</ul>`; 
            }
            
            function populateFilterDropdown(data) { const unique = [...new Set(data.map(i => i.auditee))].sort(); els.pastFilter.innerHTML = '<option value="all">Tampilkan Semua Auditee</option>'; unique.forEach(u => els.pastFilter.add(new Option(u, u))); }
            async function checkDeadlines() { if (sessionStorage.getItem('hasSeenDeadlineModal')) return; try { const r = await fetch('/api/check_deadline_notifications'); if (r.ok) { const n = await r.json(); if (n.length) { document.getElementById('deadline-notif-content').innerHTML = `Reminder: <strong>${n[0].auditee}</strong> - ${n[0].subject}`; openModal(document.getElementById('deadline-notification-modal')); sessionStorage.setItem('hasSeenDeadlineModal', 'true'); } } } catch (e) { /* ignore */ } }

            init();
        });
    </script>
</body>
</html>