<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Monitoring - {{ session_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon-32x32.png') }}" type="image/png"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .view-container { max-width: 1400px; margin: 0 auto; }
        .header-view { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .print-btn { background: #2196F3; color: white; border:none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        
        .chart-row { display: flex; gap: 20px; margin-bottom: 30px; }
        .chart-card { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        
        .table-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 15px; text-align: center; border: 1px solid #e0e0e0; font-size: 0.95rem; }
        th { background-color: #f8f9fa; font-weight: 700; color: #333; vertical-align: middle; }
        .totals-row { background-color: #C62828; color: #fff; font-weight: bold; }
        .totals-row td { border-color: #e57373; } 
    </style>
</head>
<body>

<div class="view-container">
    <div class="header-view">
        <div>
            <a href="{{ url_for('monitoring_ams_page') }}" class="back-btn">‚¨Ö Kembali ke Dashboard</a>
        </div>
        <h2 style="margin:0; color:#333;">{{ session_name }}</h2>
        <button onclick="window.print()" class="print-btn">üñ®Ô∏è Cetak / PDF</button>
    </div>

    <div class="chart-row">
        <div class="chart-card">
            <h4 style="text-align:center; margin-top:0;">Status Keseluruhan</h4>
            <div style="position: relative; height: 300px;">
                <canvas id="viewPieChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h4 style="text-align:center; margin-top:0;">Rekomentasi per Auditee</h4>
            <div style="position: relative; height: 300px;">
                <canvas id="viewBarChart"></canvas>
            </div>
        </div>
    </div>

    <div class="table-card">
        <div id="table-container">
            <p style="text-align:center;">Memuat data...</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const sessionName = "{{ session_name }}";
        const ownerId = "{{ owner_id if owner_id else '' }}";
        
        // Fetch Data
        let url = `/api/get_monitoring_data/${encodeURIComponent(sessionName)}`;
        if (ownerId) url += `?owner_id=${ownerId}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data || data.length === 0) {
                document.getElementById('table-container').innerHTML = '<p style="text-align:center">Tidak ada data.</p>';
                return;
            }

            renderViewCharts(data);
            renderViewTable(data);

        } catch (error) {
            console.error(error);
            document.getElementById('table-container').innerHTML = '<p style="color:red; text-align:center">Gagal memuat data.</p>';
        }
    });

    function calcPct(val, total) { return total > 0 ? Math.round((val / total) * 100) + '%' : '0%'; }

    function renderViewCharts(data) {
        let totalSelesai=0, totalBJT=0, totalOutstanding=0, totalBSR=0, totalBDL=0, totalTDD=0;
        let auditeeMap = {};
        const type = data[0].monitoring_type;

        data.forEach(item => {
            totalSelesai += item.selesai || 0;
            if (type === 'bpk') {
                totalBSR += item.belum_sesuai || 0; totalBDL += item.belum_tl || 0; totalTDD += item.tdd || 0;
            } else {
                totalBJT += item.tidak_selesai || 0; totalOutstanding += item.todo || 0;
            }
            if (!auditeeMap[item.auditee]) auditeeMap[item.auditee] = 0;
            auditeeMap[item.auditee] += (item.total_rekomendasi || 0);
        });
        const ctxPie = document.getElementById('viewPieChart').getContext('2d');
        let labels = ['Selesai'], cData = [totalSelesai], colors = ['#4CAF50'];
        if (type === 'bpk') {
            labels.push('Belum Sesuai', 'Belum TL', 'TDD'); cData.push(totalBSR, totalBDL, totalTDD); colors.push('#FFEB3B', '#FF5722', '#9E9E9E');
        } else {
            labels.push('Belum Jatuh Tempo', 'Outstanding'); cData.push(totalBJT, totalOutstanding); colors.push('#FF9800', '#F44336');
        }
        new Chart(ctxPie, { type: 'doughnut', data: { labels: labels, datasets: [{ data: cData, backgroundColor: colors }] }, options: { maintainAspectRatio: false } });
        const ctxBar = document.getElementById('viewBarChart').getContext('2d');
        new Chart(ctxBar, { type: 'bar', data: { labels: Object.keys(auditeeMap), datasets: [{ label: 'Total Rekomendasi', data: Object.values(auditeeMap), backgroundColor: '#2196F3' }] }, options: { maintainAspectRatio: false } });
    }

    function renderViewTable(data) {
        const type = data[0].monitoring_type;
        const groupedData = data.reduce((acc, item) => { if (!acc[item.auditee]) acc[item.auditee] = []; acc[item.auditee].push(item); return acc; }, {});
        
        let rowsHTML = '';
        let grand = { total:0, sel:0, bjt:0, out:0, bsr:0, bdl:0, tdd:0 };

        Object.keys(groupedData).sort().forEach(name => {
            const rows = groupedData[name].sort((a,b)=> a.tahun_audit - b.tahun_audit);
            const rowCount = rows.length + 1;
            
            rows.forEach((item, idx) => {
                let cells = type === 'bpk' ? 
                    `<td>${item.selesai}</td><td>${calcPct(item.selesai, item.total_rekomendasi)}</td><td>${item.belum_sesuai}</td><td>${calcPct(item.belum_sesuai, item.total_rekomendasi)}</td><td>${item.belum_tl}</td><td>${calcPct(item.belum_tl, item.total_rekomendasi)}</td><td>${item.tdd}</td><td>${calcPct(item.tdd, item.total_rekomendasi)}</td>` :
                    `<td>${item.selesai}</td><td>${calcPct(item.selesai, item.total_rekomendasi)}</td><td>${item.tidak_selesai}</td><td>${calcPct(item.tidak_selesai, item.total_rekomendasi)}</td><td>${item.todo}</td><td>${calcPct(item.todo, item.total_rekomendasi)}</td>`;
                let firstCol = idx === 0 ? `<td rowspan="${rowCount}" style="vertical-align:middle; font-weight:bold; background:#fff;">${name}</td>` : '';
                
                rowsHTML += `<tr>${firstCol}<td>${item.tahun_audit}</td><td style="font-weight:bold">${item.total_rekomendasi}</td>${cells}</tr>`;
            });
            let sub = rows.reduce((acc, c) => {
                acc.total += c.total_rekomendasi; acc.sel += c.selesai; 
                if(type==='bpk'){ acc.bsr+=c.belum_sesuai; acc.bdl+=c.belum_tl; acc.tdd+=c.tdd; }
                else { acc.bjt+=c.tidak_selesai; acc.out+=c.todo; }
                return acc;
            }, {total:0, sel:0, bjt:0, out:0, bsr:0, bdl:0, tdd:0});
            
            grand.total += sub.total; grand.sel += sub.sel; grand.bjt += sub.bjt; grand.out += sub.out; grand.bsr += sub.bsr; grand.bdl += sub.bdl; grand.tdd += sub.tdd;

            let subCells = type === 'bpk' ?
                `<td>${sub.sel}</td><td>${calcPct(sub.sel, sub.total)}</td><td>${sub.bsr}</td><td>${calcPct(sub.bsr, sub.total)}</td><td>${sub.bdl}</td><td>${calcPct(sub.bdl, sub.total)}</td><td>${sub.tdd}</td><td>${calcPct(sub.tdd, sub.total)}</td>` :
                `<td>${sub.sel}</td><td>${calcPct(sub.sel, sub.total)}</td><td>${sub.bjt}</td><td>${calcPct(sub.bjt, sub.total)}</td><td>${sub.out}</td><td>${calcPct(sub.out, sub.total)}</td>`;
            rowsHTML += `<tr style="background:#f1f1f1; font-weight:bold;"><td style="text-align:center">Total</td><td>${sub.total}</td>${subCells}</tr>`;
        });
        let footCells = type === 'bpk' ?
            `<td>${grand.sel}</td><td>${calcPct(grand.sel, grand.total)}</td><td>${grand.bsr}</td><td>${calcPct(grand.bsr, grand.total)}</td><td>${grand.bdl}</td><td>${calcPct(grand.bdl, grand.total)}</td><td>${grand.tdd}</td><td>${calcPct(grand.tdd, grand.total)}</td>` :
            `<td>${grand.sel}</td><td>${calcPct(grand.sel, grand.total)}</td><td>${grand.bjt}</td><td>${calcPct(grand.bjt, grand.total)}</td><td>${grand.out}</td><td>${calcPct(grand.out, grand.total)}</td>`;

        let thead = type === 'bpk' ?
            `<thead><tr><th rowspan="2">Auditee</th><th rowspan="2">Tahun</th><th rowspan="2">Total</th><th colspan="2" style="background:#e8f5e9">Selesai</th><th colspan="2" style="background:#fff3e0">Belum Sesuai</th><th colspan="2" style="background:#ffebee">Belum TL</th><th colspan="2" style="background:#eceff1">TDD</th></tr><tr><th>Jml</th><th>%</th><th>Jml</th><th>%</th><th>Jml</th><th>%</th><th>Jml</th><th>%</th></tr></thead>` :
            `<thead><tr><th rowspan="2">Auditee</th><th rowspan="2">Tahun</th><th rowspan="2">Total</th><th colspan="2" style="background:#e8f5e9">Selesai</th><th colspan="2" style="background:#fff3e0">Belum Jatuh Tempo</th><th colspan="2" style="background:#ffebee">Outstanding</th></tr><tr><th>Jml</th><th>%</th><th>Jml</th><th>%</th><th>Jml</th><th>%</th></tr></thead>`;

        document.getElementById('table-container').innerHTML = `<table>${thead}<tbody>${rowsHTML}</tbody><tfoot><tr class="totals-row"><td colspan="2">GRAND TOTAL</td><td>${grand.total}</td>${footCells}</tr></tfoot></table>`;
    }
</script>
</body>
</html>